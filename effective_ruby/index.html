<!DOCTYPE html>
<html lang="zh-CN">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>Document</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.css" rel="stylesheet">
    <link href="/abc.css" rel="stylesheet">
  </head>

  <body data-spy="scroll" data-target=".notes-sidebar">
    <header>
      <div class="notes-header">
        <div class="container">
          <div class="row">
            <div class="col-md-9">
              <h1>改善 Ruby 程序的 48 条建议</h1>
            </div>
            <div class="col-md-3">
              <a href="/">
                <img alt="" src="http://placehold.it/150x120?text=INDEX">
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div class="container notes-content">
        <div class="row">
          <article class="col-md-9">
<h2 id="sec-1">
<span class="heading-number heading-number-1">1</span> 让自己熟悉 Ruby</h2>
<h3 id="sec-1-1">
<span class="heading-number heading-number-2">1.1</span> 理解 Ruby 中的 True</h3>
<ul>
  <li>除了 <code>false</code> 和 <code>nil</code> 外，其他都是真值</li>
  <li>区分 false 和 nil 的方法</li>
</ul>
<pre class="src" lang="ruby">
x.nil?
<span style="color:#069">false</span> == x
</pre>
<h3 id="sec-1-2">
<span class="heading-number heading-number-2">1.2</span> 所有对象的值都可能为 nil</h3>
<ul>
  <li>下面两行等价</li>
</ul>
<pre class="src" lang="ruby">
person.save <span style="color:#080;font-weight:bold">if</span> person
person.save <span style="color:#080;font-weight:bold">if</span> !person.nil?
</pre>
<h3 id="sec-1-3">
<span class="heading-number heading-number-2">1.3</span> 避免使用 Ruby 中古怪的 Perl 风格语法</h3>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">if</span> message =~ <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">^ERROR: </span><span style="color:#D20">\s</span><span style="color:#808">+(.+)$</span><span style="color:#404">/</span></span>; <span style="color:#d70">$1</span> <span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good use MatchData</span>
<span style="color:#080;font-weight:bold">if</span> m = message.match(<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">^ERROR: </span><span style="color:#D20">\s</span><span style="color:#808">+(.+)$</span><span style="color:#404">/</span></span>); m[<span style="color:#00D">1</span>] <span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># bad</span>
<span style="color:#d70">$:</span>  <span style="color:#777">#=&gt; $LOAD_PATH</span>
</pre>
<h3 id="sec-1-4">
<span class="heading-number heading-number-2">1.4</span> 留神，常量是可变的</h3>
<ul>
  <li>全部冻结（集合对象及元素）</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">Defaults</span>
  <span style="color:#036;font-weight:bold">NETWORKS</span> = [
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">192.168.1.1</span><span style="color:#710">'</span></span>
  ].map!(&amp;<span style="color:#A60">:freeze</span>).freeze
<span style="color:#080;font-weight:bold">end</span>

</pre>
<h3 id="sec-1-5">
<span class="heading-number heading-number-2">1.5</span> 留意运行时警告</h3>
<ul>
  <li>ruby -w</li>
  <li>$VERBOSE</li>
  <li>t.warning = true  # in Rakefile</li>
</ul>
<h2 id="sec-2">
<span class="heading-number heading-number-1">2</span> 类、对象和模块</h2>
<h3 id="sec-2-1">
<span class="heading-number heading-number-2">2.1</span> 了解 Ruby 如何构建继承体系</h3>
<h4 id="sec-2-1-1">
<span class="heading-number heading-number-3">2.1.1</span> 对象、类、模块</h4>
<blockquote>
  <ul>
    <li>对象是变量的容器
      这些对象被称为 <b>实例变量</b> 代表这对象的状态
      对象有一个特殊的内部变量链接唯一的一个类 （TODO）</li>
    <li>类是方法和常量的容器
      <b>实例方法</b> 代表类所有对象的行为
      类也是对象，则类也是类变量的容器
      类是一种器变量称为类变量，其方法称为类方法的对象。</li>
    <li>模块和类相似，除了不能实例化以及更严格的语法。
      可以将模块 <code>include</code> 进类，实现多重继承的效果。</li>
    <li>单件类（singleton）是继承体系中的一个匿名且不可见的类。
      （有时也称 eigenclasses/metaclasses）
      提供了存储类方法和从 modules 中引入的方法的空间
      与常规类不同，它们是动态创建的，不能被实例化。
      单件类不同于常规类奉献精神 - 所有对象都可以使用方法，单件类只服务一个对象。
      类方法是作为单件类的实例方法存储的。</li>
    <li>接收者是调用方法的对象。
      <code>foo.name</code> 接收者是 foo，当 name 方法执行时，self 变量被设置在 foo 上。
      方法省略时，隐式将 <code>self</code> 设置成当前上下文</li>
  </ul>
</blockquote>
<h4 id="sec-2-1-2">
<span class="heading-number heading-number-3">2.1.2</span> 继承体系</h4>
<ul>
  <li>Foo/Object/Kernel/BasicObject</li>
  <li>只使用 <code>superclass</code> 时会省略 module 比如 kernel</li>
</ul>
<h4 id="sec-2-1-3">
<span class="heading-number heading-number-3">2.1.3</span> 引入模块时发生的事情</h4>
<ul>
  <li>创建一个单件类并插入类继承体系中。（共享实例方法和常量）</li>
  <li>include 后插入到当前类的上方，查找方法时（后进先出 LIFO）优先级仅次于当前类</li>
</ul>
<h4 id="sec-2-1-4">
<span class="heading-number heading-number-3">2.1.4</span> 查找方法</h4>
<ol>
  <li>找到接收者的类</li>
  <li>查找该类中存储的实例方法列表，找到就停止并执行代码</li>
  <li>顺着继承体系找到超类（包括超类是单件类），并重复第 2 步</li>
  <li>重复 2，3 直到抵达体系的根（*BasicObject*）</li>
  <li>找不到方法，就重头开始找方法 <code>method_missing</code>
</li>
</ol>
<h4 id="sec-2-1-5">
<span class="heading-number heading-number-3">2.1.5</span> 有用的方法</h4>
<ul>
  <li>singleton_class.instance_method(false)
    <ul>
      <li>#<a href="Class:Foo">Class:Foo</a>
</li>
    </ul>
  </li>
  <li>ancestors</li>
  <li>included_modules</li>
</ul>
<h3 id="sec-2-2">
<span class="heading-number heading-number-2">2.2</span> 了解 super 的不同行为</h3>
<ul>
  <li>三种 <b>super</b> (关键字)行为</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">foo</span>(x, y)
  <span style="color:#080;font-weight:bold">super</span>(<span style="color:#00D">1</span>,<span style="color:#00D">2</span>)
  <span style="color:#080;font-weight:bold">super</span>     <span style="color:#777">#=&gt; super(x, y)</span>
  <span style="color:#080;font-weight:bold">super</span>()   <span style="color:#777">#无参数</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<ul>
  <li>super 可以调用引入模块的方法</li>
</ul>
<h3 id="sec-2-3">
<span class="heading-number heading-number-2">2.3</span> 初始化子类时调用 super</h3>
<ul>
  <li>如要显示使用继承的定义 initialize 方法时，需要使用 super 来初始化其父类</li>
</ul>
<h3 id="sec-2-4">
<span class="heading-number heading-number-2">2.4</span> 提防 Ruby 最棘手的解析</h3>
<h4 id="sec-2-4-1">
<span class="heading-number heading-number-3">2.4.1</span> setter 方法在调用时需要显式的接收者，否则被解析成变量赋值</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Counter</span>
  attr_accessor <span style="color:#A60">:counter</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>
    counter =  <span style="color:#00D">0</span>  <span style="color:#777"># local variale assign</span>
    <span style="color:#069">self</span>.counter = <span style="color:#00D">0</span>  <span style="color:#777"># right</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">bar</span>
    counter + <span style="color:#00D">1</span>  <span style="color:#777"># right = self.counter + 1</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</pre>
<h3 id="sec-2-5">
<span class="heading-number heading-number-2">2.5</span> 推荐使用 Struct 而非 Hash 存储结构化数据</h3>
<h4 id="sec-2-5-1">
<span class="heading-number heading-number-3">2.5.1</span> 不应该将 hash 数组通过公共接口向外暴露</h4>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AnnualWeather</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(file_name)
    <span style="color:#33B">@readings</span> =  []

    <span style="color:#036;font-weight:bold">CSV</span>.foreach(file_name, <span style="color:#606">headers</span>: <span style="color:#069">true</span>) <span style="color:#080;font-weight:bold">do</span> |row|
      <span style="color:#33B">@readings</span> &lt;&lt; {
        <span style="color:#606">date</span>: <span style="color:#036;font-weight:bold">Date</span>.parse(row[<span style="color:#00D">2</span>]),
        <span style="color:#606">high</span>: row[<span style="color:#00D">10</span>].to_f,
        <span style="color:#606">low</span>: row[<span style="color:#00D">11</span>].to_f
      }
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">mean</span>
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#60E">0.0</span> <span style="color:#080;font-weight:bold">if</span> <span style="color:#33B">@readings</span>.size.zero?

    total = <span style="color:#33B">@readings</span>.reduce(<span style="color:#60E">0.0</span>) <span style="color:#080;font-weight:bold">do</span> |sum, reading|
      sum + (reading[<span style="color:#A60">:high</span>] + reading[<span style="color:#A60">:low</span>]) / <span style="color:#60E">2.0</span>
    <span style="color:#080;font-weight:bold">end</span>

    total / <span style="color:#33B">@readings</span>.size.to_f
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AnnualWeather</span>
  <span style="color:#036;font-weight:bold">Reading</span> = <span style="color:#036;font-weight:bold">Struct</span>.new(<span style="color:#A60">:date</span>, <span style="color:#A60">:high</span>, <span style="color:#A60">:low</span>) <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">mean</span> <span style="color:#777"># struct object method</span>
      (high + low) / <span style="color:#60E">2.0</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(file_name)
    <span style="color:#33B">@readings</span> =  []

    <span style="color:#036;font-weight:bold">CSV</span>.foreach(file_name, <span style="color:#606">headers</span>: <span style="color:#069">true</span>) <span style="color:#080;font-weight:bold">do</span> |row|
      <span style="color:#33B">@readings</span> &lt;&lt; <span style="color:#036;font-weight:bold">Reading</span>.new(<span style="color:#036;font-weight:bold">Date</span>.parse(row[<span style="color:#00D">2</span>]), row[<span style="color:#00D">10</span>].to_f, row[<span style="color:#00D">11</span>].to_f)
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">mean</span>
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#60E">0.0</span> <span style="color:#080;font-weight:bold">if</span> <span style="color:#33B">@readings</span>.size.zero?

    total = <span style="color:#33B">@readings</span>.reduce(<span style="color:#60E">0.0</span>) <span style="color:#080;font-weight:bold">do</span> |sum, reading|
      sum + <span style="color:#036;font-weight:bold">Reading</span>.new(reading.high, reading.low).mean  <span style="color:#777"># awsome</span>
    <span style="color:#080;font-weight:bold">end</span>

    total / <span style="color:#33B">@readings</span>.size.to_f
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</pre>
<ul>
  <li>结构化数据时，如果创建一个新类不合适，推荐使用 Struct 而非 Hash</li>
</ul>
<h3 id="sec-2-6">
<span class="heading-number heading-number-2">2.6</span> 通过在模块中嵌入代码来创建命名空间</h3>
<h4 id="sec-2-6-1">
<span class="heading-number heading-number-3">2.6.1</span> module 可以做命令空间，以便方法隔离</h4>
<h4 id="sec-2-6-2">
<span class="heading-number heading-number-3">2.6.2</span> module 词法作用域</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">Foo</span>
  <span style="color:#036;font-weight:bold">KEY</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">passoword</span><span style="color:#710">'</span></span>

  <span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Bar</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(key = <span style="color:#036;font-weight:bold">KEY</span>)  <span style="color:#777"># right</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">Foo</span>
  <span style="color:#036;font-weight:bold">KEY</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">passoword</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span> <span style="color:#777"># 词法作用域关闭</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Bar</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(key = <span style="color:#036;font-weight:bold">KEY</span>)  <span style="color:#777"># Nameerror, use Foo::KEY</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<pre class="src" lang="ruby">
<span style="color:#036;font-weight:bold">Foo</span>::<span style="color:#036;font-weight:bold">Bar</span>
::<span style="color:#036;font-weight:bold">Bar</span>  <span style="color:#777"># 顶级空间</span>
</pre>
<blockquote>
  <p>模块名（常量）可以看作全局常量，这时所有顶级常量都被存在 <b>Object</b> 类中。
    所以查找方式：</p>
  <ul>
    <li>当前词法作用域</li>
    <li>继承体系</li>
  </ul>
</blockquote>
<h3 id="sec-2-7">
<span class="heading-number heading-number-2">2.7</span> 理解等价的不同用法</h3>
<h4 id="sec-2-7-1">
<span class="heading-number heading-number-3">2.7.1</span> 四种等价比较</h4>
<table>
  <tr>
<th></th>
<th>含义</th>
<th>应用场景</th>
<th>举例</th>
<th>附注</th>
</tr>
  <tr>
<td>==</td>
<td>值相等</td>
<td></td>
<td><code>1 == 1.0</code></td>
<td>类型隐式转换</td>
</tr>
  <tr>
<td>equal?</td>
<td>同一对象</td>
<td>检查两个对象是否指向内存同一块</td>
<td></td>
<td>除了数字，其他都是引用</td>
</tr>
  <tr>
<td>eql?</td>
<td>Hash 的键比较</td>
<td>Hash 类中比较对象的 Key</td>
<td></td>
<td></td>
</tr>
  <tr>
<td>===</td>
<td>case 等价</td>
<td>case when 条件中隐式调用</td>
<td></td>
<td></td>
</tr>
</table>
<h4 id="sec-2-7-2">
<span class="heading-number heading-number-3">2.7.2</span> eql? 示例</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Color</span>
  attr_reader <span style="color:#A60">:name</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(name)
    <span style="color:#33B">@name</span> = name
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">hash</span>
    name.hash
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">eql?</span>(other)
    name.eql?(other.name)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

a = <span style="color:#036;font-weight:bold">Color</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">pink</span><span style="color:#710">'</span></span>)
b = <span style="color:#036;font-weight:bold">Color</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">pink</span><span style="color:#710">'</span></span>)

{a =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">like</span><span style="color:#710">'</span></span>, b =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">love</span><span style="color:#710">'</span></span> }  
<span style="color:#777">#=&gt; {#&lt;Color:0x007fa74586a288 @name="pink"&gt;=&gt;"love"}</span>
</pre>
<h4 id="sec-2-7-3">
<span class="heading-number heading-number-3">2.7.3</span> === 示例</h4>
<ul>
  <li>case 之后的表达式总是出现在 <code>===</code> 的右侧</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">case</span> command
<span style="color:#080;font-weight:bold">when</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">start</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">then</span> start
<span style="color:#080;font-weight:bold">when</span> <span style="color:#036;font-weight:bold">Numeric</span> <span style="color:#080;font-weight:bold">then</span> timer(command)
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># ===</span>
<span style="color:#080;font-weight:bold">if</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">start</span><span style="color:#710">'</span></span> === command <span style="color:#080;font-weight:bold">then</span> start
<span style="color:#080;font-weight:bold">elsif</span> <span style="color:#036;font-weight:bold">Numeric</span> === command <span style="color:#080;font-weight:bold">then</span> timer(command)
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h4 id="sec-2-7-4">
<span class="heading-number heading-number-3">2.7.4</span> Regexp#== vs String#===</h4>
<pre class="src" lang="ruby">
<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">er</span><span style="color:#404">/</span></span> === <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Tyler</span><span style="color:#710">'</span></span>
<span style="color:#777">#=&gt; true</span>

<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Tyler</span><span style="color:#710">'</span></span> == <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">er</span><span style="color:#404">/</span></span>
<span style="color:#777">#=&gt; false</span>
</pre>
<h4 id="sec-2-7-5">
<span class="heading-number heading-number-3">2.7.5</span> is_a? vs ===</h4>
<pre class="src" lang="ruby">
[<span style="color:#00D">1</span>, <span style="color:#00D">2</span>, <span style="color:#00D">3</span>].is_a?(<span style="color:#036;font-weight:bold">Array</span>)

<span style="color:#036;font-weight:bold">Array</span> === [<span style="color:#00D">1</span>, <span style="color:#00D">2</span>, <span style="color:#00D">3</span>]
</pre>
<h3 id="sec-2-8">
<span class="heading-number heading-number-2">2.8</span> 通过”&lt;=&gt;”操作符实现比较和比较模块</h3>
<ul>
  <li>hash ?</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#777"># coding: utf-8</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Version</span>
  include <span style="color:#036;font-weight:bold">Comparable</span>  <span style="color:#777"># &gt;,&lt; etc.</span>
  attr_reader <span style="color:#A60">:major</span>, <span style="color:#A60">:minor</span>, <span style="color:#A60">:patch</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(version)
    <span style="color:#33B">@major</span>, <span style="color:#33B">@minor</span>, <span style="color:#33B">@patch</span> = version.split(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">.</span><span style="color:#710">'</span></span>).map(&amp;<span style="color:#A60">:to_i</span>)
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">&lt;=&gt;</span>(other)
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">nil</span> <span style="color:#080;font-weight:bold">unless</span> other.is_a?(<span style="color:#036;font-weight:bold">Version</span>)

    [major &lt;=&gt; other.major,
     minor &lt;=&gt; other.minor,
     patch &lt;=&gt; other.patch
    ].detect { |n| !n.zero? } || <span style="color:#00D">0</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#777"># 定义 hash 方法</span>
  alias_method <span style="color:#A60">:eql?</span>, <span style="color:#A60">:==</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">hash</span>
    [major, minor, patch].hash
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

vs = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%w(</span><span style="color:#D20"> 1.0.0 1.11.1 1.9.0</span><span style="color:#710">)</span></span>.map {|v| <span style="color:#036;font-weight:bold">Version</span>.new(v)}
vs.sort
</pre>
<h3 id="sec-2-9">
<span class="heading-number heading-number-2">2.9</span> 通过 protected 方法共享私有状态</h3>
<h4 id="sec-2-9-1">
<span class="heading-number heading-number-3">2.9.1</span> protected 方法共享私有状态（相关类 - 同一类或超类）</h4>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Widget</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">overlapping?</span>(other)
    x1, y1 = <span style="color:#33B">@screen_x</span>, <span style="color:#33B">@screen_y</span>
    x2, y2 = other.instance_eval { [<span style="color:#33B">@screen_x</span>, <span style="color:#33B">@screen_y</span>] }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Widget</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">overlapping?</span>(other)
    x1, y1 = screen_coordinates
    x2, y2 = other.screen_coordinates
  <span style="color:#080;font-weight:bold">end</span>

  protected
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">screen_coordinates</span>
    [<span style="color:#33B">@screen_x</span>, <span style="color:#33B">@screen_y</span>]
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-2-10">
<span class="heading-number heading-number-2">2.10</span> 优先使用实例变量而非类变量</h3>
<ul>
  <li>实例变量 - 子类独一份</li>
  <li>类变量 - 子类共一份</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#777"># coding: utf-8</span>
<span style="color:#777"># error</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Singleton</span>
  private_class_method <span style="color:#A60">:new</span>, <span style="color:#A60">:dup</span>, <span style="color:#A60">:clone</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">instance</span>
    <span style="color:#369">@@single</span> ||= new  <span style="color:#777"># 超类的类变量被所有子类共享</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Configuration</span> &lt; <span style="color:#036;font-weight:bold">Singleton</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Database</span> &lt; <span style="color:#036;font-weight:bold">Singleton</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">Configuration</span>.instance  <span style="color:#777">#=&gt; #&lt;Configuration&gt;</span>
<span style="color:#036;font-weight:bold">Database</span>.instance  <span style="color:#777">#=&gt; #&lt;Configuration&gt;</span>

<span style="color:#777"># right</span>
<span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">instance</span>
  <span style="color:#33B">@single</span> ||= new
<span style="color:#080;font-weight:bold">end</span>
</pre>
<blockquote>
  <p>类方法实际上就是类对象的实例方法</p>
</blockquote>
<h4 id="sec-2-10-1">
<span class="heading-number heading-number-3">2.10.1</span> 线程安全单键模式</h4>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">singleton</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">Configuration</span>
  include <span style="color:#036;font-weight:bold">Singleton</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h2 id="sec-3">
<span class="heading-number heading-number-1">3</span> 集合</h2>
<ul>
  <li>Array, Hash, Set</li>
</ul>
<h3 id="sec-3-1">
<span class="heading-number heading-number-2">3.1</span> 在改变作为参数的集合之前复制它们</h3>
<blockquote>
  <p>集合类实际存储对象的引用，除了 Fixnum
    方法参数也类似</p>
</blockquote>
<ul>
  <li>delete vs reject</li>
</ul>
<h4 id="sec-3-1-1">
<span class="heading-number heading-number-3">3.1.1</span> dup vs clone</h4>
<blockquote>
  <p>clone 会保留原始对象的两个附加特性（freeze, 存在单件类）</p>
</blockquote>
<h4 id="sec-3-1-2">
<span class="heading-number heading-number-3">3.1.2</span> 拷贝</h4>
<table>
  <tr>
<th></th>
<th>类型</th>
<th>缺点</th>
<th>说明</th>
</tr>
  <tr>
<td>dup</td>
<td>浅拷贝</td>
<td></td>
<td>只复制了容器本身</td>
</tr>
  <tr>
<td>clone</td>
<td></td>
<td></td>
<td></td>
</tr>
  <tr>
<td>Mashal</td>
<td>深拷贝</td>
<td>消耗内存/有些类不能序列化（IO/File）</td>
<td>包括了其中的元素</td>
    <ul>
      <li>可以重写 <code>initialize_copy</code> 控制赋值过程的深度</li>
    </ul>
  </tr>
</table>
<h3 id="sec-3-2">
<span class="heading-number heading-number-2">3.2</span> 使用 Array 方法将 nil 及标量对象转换成数组</h3>
<pre class="src" lang="ruby">
Array(<span style="color:#069">nil</span>)  <span style="color:#777">#=&gt; []</span>
Array({ <span style="color:#606">a</span>: <span style="color:#00D">1</span> })  <span style="color:#777">#=&gt; [[:a, 1]] 反转用 Hash[]</span>
</pre>
<h3 id="sec-3-3">
<span class="heading-number heading-number-2">3.3</span> 考虑使用集合高效检查元素的包含性</h3>
<p>Ruby 自带两套库：</p>
<ul>
  <li>核心库已经预先加载</li>
  <li>标准库，比如：Set</li>
</ul>
<h4 id="sec-3-3-1">
<span class="heading-number heading-number-3">3.3.1</span> Set 使用</h4>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Role</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(name, permissions)
    <span style="color:#33B">@name</span>, <span style="color:#33B">@permissions</span> = name, permissions  <span style="color:#777"># bad</span>
    <span style="color:#777"># @permissions = Hash[permissions.map { |p| [p, true] }]  # litter better</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">can?</span>(permission)
    <span style="color:#33B">@permissions</span>.include?(permission)  <span style="color:#777"># Array O(n); Hash O(logn)</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">set</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Role</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(name, permissions)
    <span style="color:#33B">@name</span>, <span style="color:#33B">@permission</span> = name, <span style="color:#036;font-weight:bold">Set</span>.new(permissions)  <span style="color:#777"># O(logn)</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<blockquote>
  <p><b>Set</b> 是无序的容器，若要有序的使用 <b>SortedSet</b></p>
</blockquote>
<h3 id="sec-3-4">
<span class="heading-number heading-number-2">3.4</span> 了解如何通过 reduce 方法折叠集合</h3>
<h4 id="sec-3-4-1">
<span class="heading-number heading-number-3">3.4.1</span> reduce 函数由三部分组成：</h4>
<ul>
  <li>枚举的对象是接收者（比如引入 <b>Enumberable</b> ）</li>
  <li>每个元素调用一次，每次都有返回值，这个返回值代表最终生成的数据结构</li>
  <li>初始对象（累加器），一次块的调用都会接受当前累加器的值并返回新的累加器值
    <ul>
      <li>参数是累加器的初始值（枚举类型为空，则返回这个值）</li>
    </ul>
  </li>
</ul>
<h4 id="sec-3-4-2">
<span class="heading-number heading-number-3">3.4.2</span> 应用</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">sum</span>(enum)
  enum.reduce(<span style="color:#00D">0</span>) <span style="color:#080;font-weight:bold">do</span> |accumulator, element| 
    accumulator + element
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">sum</span>(enum)
  enum.reduce(<span style="color:#00D">0</span>, <span style="color:#A60">:+</span>)
  <span style="color:#777"># enum.reduce(0, &amp;:+)</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">Hash</span>[array.map { |x| [x, <span style="color:#069">true</span>] }]

array.reduce({}) <span style="color:#080;font-weight:bold">do</span> |hash, element|
  hash.update(element =&gt; <span style="color:#069">true</span>)
  <span style="color:#777"># hash[element] = true</span>
  <span style="color:#777"># hash</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># bad</span>
users.select { |u| u.age &gt;= <span style="color:#00D">21</span> }.map(&amp;<span style="color:#A60">:name</span>)

<span style="color:#777"># good</span>
users.reduce([]) <span style="color:#080;font-weight:bold">do</span> |names, user|
  names &lt;&lt; user.name <span style="color:#080;font-weight:bold">if</span> user.age &gt;= <span style="color:#00D">21</span>
  names
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-3-5">
<span class="heading-number heading-number-2">3.5</span> 考虑使用默认哈希值</h3>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">frequency</span>(array)
  <span style="color:#777"># bad</span>
  array.reduce({}) <span style="color:#080;font-weight:bold">do</span> |hash, element|
    hash[element] ||= <span style="color:#00D">0</span>
    hash[element] += <span style="color:#00D">1</span>
    hash
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#777"># good</span>
  <span style="color:#777"># 0 默认值是没有找到才用到</span>
  array.reduce(<span style="color:#036;font-weight:bold">Hash</span>.new(<span style="color:#00D">0</span>)) <span style="color:#080;font-weight:bold">do</span> |hash, element|
    hash[element] += <span style="color:#00D">1</span>
    hash
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h4 id="sec-3-5-1">
<span class="heading-number heading-number-3">3.5.1</span> Hash.new</h4>
<pre class="src" lang="ruby">
h = <span style="color:#036;font-weight:bold">Hash</span>.new(<span style="color:#00D">42</span>)
h[<span style="color:#A60">:miss</span>]
h.keys <span style="color:#777">#=&gt; []</span>

h[<span style="color:#A60">:miss</span>] += <span style="color:#00D">1</span>
h.keys <span style="color:#777">#=&gt; [:miss]</span>

<span style="color:#777">#---------------</span>
h = <span style="color:#036;font-weight:bold">Hash</span>.new([])
h[<span style="color:#A60">:miss</span>]
h[<span style="color:#A60">:miss</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">hey</span><span style="color:#710">'</span></span>  <span style="color:#777"># 默认值改变</span>
h.keys <span style="color:#777">#=&gt; []</span>

h[<span style="color:#A60">:miss</span>] <span style="color:#777">#=&gt; ['key']</span>
h[<span style="color:#A60">:missd</span>] <span style="color:#777">#=&gt; ['key']</span>

h.default <span style="color:#777">#=&gt; ['key']</span>

<span style="color:#777">#---------------</span>
<span style="color:#777">## &lt;&lt; 两个键共享同一个默认数组</span>
h = <span style="color:#036;font-weight:bold">Hash</span>.new([])
h[<span style="color:#A60">:week</span>] = h[<span style="color:#A60">:week</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Monday</span><span style="color:#710">'</span></span>
h[<span style="color:#A60">:months</span>] = h[<span style="color:#A60">:months</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">January</span><span style="color:#710">'</span></span>
h.keys  <span style="color:#777">#=&gt; ['Monday', 'January']</span>

h[<span style="color:#A60">:week</span>] <span style="color:#777">#=&gt; ['Monday', 'January']</span>
h.default <span style="color:#777">#=&gt; ['Monday', 'January'] </span>

<span style="color:#777">#right</span>
h = <span style="color:#036;font-weight:bold">Hash</span>.new { [] }

<span style="color:#777"># better</span>
h = <span style="color:#036;font-weight:bold">Hash</span>.new { |hash, key| hash[key] = [] }
h[<span style="color:#A60">:week</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Monday</span><span style="color:#710">'</span></span>
h[<span style="color:#A60">:holidays</span>]  <span style="color:#777">#=&gt; []</span>
h.keys  <span style="color:#777">#=&gt; [:week, :holidays]</span>
</pre>
<p>Hash.new { [] }  # 当需要默认值时这个会被调用，并友好得返回一个新创建的数组</p>
<h4 id="sec-3-5-2">
<span class="heading-number heading-number-3">3.5.2</span> 使用 <code>has_key?</code> 来检测 hash 包含某个键</h4>
<h4 id="sec-3-5-3">
<span class="heading-number heading-number-3">3.5.3</span> 使用 fetch</h4>
<ul>
  <li>h.fetch(:week) - 当获取不存在的键，抛出异常(KeyError)</li>
  <li>h.fetch(:week, []) - 当获取不存在的键，用第二个参数代替</li>
</ul>
<h3 id="sec-3-6">
<span class="heading-number heading-number-2">3.6</span> 对集合优先使用委托而非继承</h3>
<ul>
  <li>委托 - 有一个（has a)</li>
  <li>继承 - 是一个（is a）</li>
</ul>
<h4 id="sec-3-6-1">
<span class="heading-number heading-number-3">3.6.1</span> 委托示例</h4>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">forwoardable</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RaisingHash</span>
  extend <span style="color:#036;font-weight:bold">Forwardable</span>
  include <span style="color:#036;font-weight:bold">Enumerable</span>

  def_delegators(<span style="color:#A60">:@hash</span>, <span style="color:#A60">:[]</span>, <span style="color:#A60">:[]=</span>, <span style="color:#A60">:delete</span>, <span style="color:#A60">:each</span>,
                 <span style="color:#A60">:keys</span>, <span style="color:#A60">:values</span>, <span style="color:#A60">:length</span>,
                 <span style="color:#A60">:empty?</span>, <span style="color:#A60">:has_key?</span>)

  <span style="color:#777"># Forward self.earase! to @hash.delete</span>
  def_delegator(<span style="color:#A60">:@hash</span>, <span style="color:#A60">:delete</span>, <span style="color:#A60">:erase!</span>)
<span style="color:#080;font-weight:bold">end</span>
</pre>
<ul>
  <li>default_proc 方法是传给 Hash::neww 的块</li>
</ul>
<h2 id="sec-4">
<span class="heading-number heading-number-1">4</span> 异常</h2>
<h3 id="sec-4-1">
<span class="heading-number heading-number-2">4.1</span> 使用定制的异常而不是抛出字符串</h3>
<h4 id="sec-4-1-1">
<span class="heading-number heading-number-3">4.1.1</span> 创建新的异常类</h4>
<ul>
  <li>必须继承 StandardError (rescue 的默认行为)</li>
  <li>异常类名称以”Error”结尾</li>
</ul>
<h4 id="sec-4-1-2">
<span class="heading-number heading-number-3">4.1.2</span> 编写异常类</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CoffeeTooWeakError</span> &lt; <span style="color:#036;font-weight:bold">StandardError</span>
<span style="color:#080;font-weight:bold">end</span>

raise <span style="color:#036;font-weight:bold">CoffeeTooWeakError</span>
raise <span style="color:#036;font-weight:bold">CoffeeTooWeakError</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">coffee to water ratio too low</span><span style="color:#710">"</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TemperatureError</span> &lt; <span style="color:#036;font-weight:bold">StandardError</span>
  attr_reader <span style="color:#A60">:temperature</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(temperature)
    <span style="color:#33B">@temperature</span> = temperature
    <span style="color:#080;font-weight:bold">super</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">invalid temperature: </span><span style="color:#666">#</span><span style="color:#33B">@temperature</span><span style="color:#710">"</span></span>)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

raise TemperatureError(<span style="color:#00D">190</span>)
</pre>
<ul>
  <li>raise 既能接受异常类对象，也能接受异常类（其实是隐式调用该类 new）</li>
</ul>
<p>
</p>
<h3 id="sec-4-2">
<span class="heading-number heading-number-2">4.2</span> 通过块和 ensure 管理资源</h3>
<pre class="src" lang="ruby">
<span style="color:#036;font-weight:bold">File</span>.open(file_name, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">w</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span> | file|
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Lock</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">acquire</span>
    lock = new  <span style="color:#777"># Initialize the resource</span>
    lock.exclusive_lock!

    <span style="color:#080;font-weight:bold">if</span> block_given?
      <span style="color:#080;font-weight:bold">yield</span> lock  <span style="color:#777"># Give it to the block</span>
    <span style="color:#080;font-weight:bold">else</span>
      lock
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">ensure</span>
    <span style="color:#080;font-weight:bold">if</span> block_given?
      lock.unlock <span style="color:#080;font-weight:bold">if</span> lock
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">Lock</span>.acquire <span style="color:#080;font-weight:bold">do</span> |lock|
  <span style="color:#777"># Raising an exception here is Okay.</span>
<span style="color:#080;font-weight:bold">end</span>
<span style="color:#036;font-weight:bold">Lock</span>.acquire  <span style="color:#777"># Won't automatically unlock</span>
</pre>
<h3 id="sec-4-3">
<span class="heading-number heading-number-2">4.3</span> 通过临近的 end 退出 ensure 语句</h3>
<ul>
  <li>不要在 ensure 里 return</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">a</span>
  <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">2</span>
<span style="color:#080;font-weight:bold">ensure</span>
  <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">3</span>
<span style="color:#080;font-weight:bold">end</span>
a  <span style="color:#777">#=&gt; 3</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">a</span>
  <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">2</span>
<span style="color:#080;font-weight:bold">ensure</span>
  <span style="color:#00D">3</span>
<span style="color:#080;font-weight:bold">end</span>
a  <span style="color:#777">#=&gt; 3</span>
</pre>
<h3 id="sec-4-4">
<span class="heading-number heading-number-2">4.4</span> 限制 retry 次数，改变重试频率并记录异常信息</h3>
<pre class="src" lang="ruby">
retries = <span style="color:#00D">0</span>

<span style="color:#080;font-weight:bold">begin</span>
  service.update record
<span style="color:#080;font-weight:bold">rescue</span> <span style="color:#036;font-weight:bold">VendorDeadlockError</span> =&gt; e
  raise  <span style="color:#080;font-weight:bold">if</span> retries &gt;= <span style="color:#00D">3</span>
  retries += <span style="color:#00D">1</span>
  logger.warn(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">API failure: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>e<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">, retrying...</span><span style="color:#710">"</span></span>)
  sleep(<span style="color:#00D">5</span>**retries)
  <span style="color:#080;font-weight:bold">retry</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-4-5">
<span class="heading-number heading-number-2">4.5</span> throw 比 raise 更适合用来跳出作用域</h3>
<ul>
  <li>catch throw 是安全版的 goto</li>
  <li>可以跳出多重迭代</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">begin</span>
  <span style="color:#33B">@characters</span>.each <span style="color:#080;font-weight:bold">do</span> |character|
    <span style="color:#33B">@colors</span>.each <span style="color:#080;font-weight:bold">do</span> |colors|
      <span style="color:#080;font-weight:bold">if</span> players.valid?(character, color)
        raise <span style="color:#036;font-weight:bold">StopIteration</span>
      <span style="color:#080;font-weight:bold">end</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">rescue</span> <span style="color:#036;font-weight:bold">StopIteration</span>
  <span style="color:#777">#...</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
match = catch(<span style="color:#A60">:jump</span>) <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@characters</span>.each <span style="color:#080;font-weight:bold">do</span> |character|
    <span style="color:#33B">@colors</span>.each <span style="color:#080;font-weight:bold">do</span> |colors|
      <span style="color:#080;font-weight:bold">if</span> players.valid?(character, color)
        throw <span style="color:#A60">:jump</span>, [character, color]
      <span style="color:#080;font-weight:bold">end</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h2 id="sec-5">
<span class="heading-number heading-number-1">5</span> 元编程 [0/8]</h2>
<h3 id="sec-5-1">
<span class="heading-number heading-number-2">5.1</span> <span class="todo-keyword TODO">TODO</span> 熟悉 Ruby 模块和类的钩子方法</h3>
<h3 id="sec-5-2">
<span class="heading-number heading-number-2">5.2</span> <span class="todo-keyword TODO">TODO</span> 在类的钩子方法中执行 super 方法</h3>
<h3 id="sec-5-3">
<span class="heading-number heading-number-2">5.3</span> <span class="todo-keyword TODO">TODO</span> 推荐使用 define_method 而非 method_missing</h3>
<h3 id="sec-5-4">
<span class="heading-number heading-number-2">5.4</span> <span class="todo-keyword TODO">TODO</span> 了解不同类型的 eval 间的差异</h3>
<h3 id="sec-5-5">
<span class="heading-number heading-number-2">5.5</span> <span class="todo-keyword TODO">TODO</span> 慎用猴子补丁</h3>
<h3 id="sec-5-6">
<span class="heading-number heading-number-2">5.6</span> <span class="todo-keyword TODO">TODO</span> 使用别名链执行被修改的方法</h3>
<h3 id="sec-5-7">
<span class="heading-number heading-number-2">5.7</span> <span class="todo-keyword TODO">TODO</span> 支持多种 Proc 参数数量</h3>
<h3 id="sec-5-8">
<span class="heading-number heading-number-2">5.8</span> <span class="todo-keyword TODO">TODO</span> 使用模块前置时请谨慎思考</h3>
<h2 id="sec-6">
<span class="heading-number heading-number-1">6</span> 测试 [0/4]</h2>
<h3 id="sec-6-1">
<span class="heading-number heading-number-2">6.1</span> <span class="todo-keyword TODO">TODO</span> 熟悉单元测试工具 MiniTest</h3>
<h3 id="sec-6-2">
<span class="heading-number heading-number-2">6.2</span> <span class="todo-keyword TODO">TODO</span> 熟悉 MiniTest 的需求测试</h3>
<h3 id="sec-6-3">
<span class="heading-number heading-number-2">6.3</span> <span class="todo-keyword TODO">TODO</span> 使用 Mock 模拟特定对象</h3>
<h3 id="sec-6-4">
<span class="heading-number heading-number-2">6.4</span> <span class="todo-keyword TODO">TODO</span> 力争代码被有效测试过</h3>
<h2 id="sec-7">
<span class="heading-number heading-number-1">7</span> 工具与库 [0/4]</h2>
<h3 id="sec-7-1">
<span class="heading-number heading-number-2">7.1</span> <span class="todo-keyword TODO">TODO</span> 学会使用 Ruby 文档</h3>
<h3 id="sec-7-2">
<span class="heading-number heading-number-2">7.2</span> <span class="todo-keyword TODO">TODO</span> 认识 IRB 的高级特性</h3>
<h3 id="sec-7-3">
<span class="heading-number heading-number-2">7.3</span> <span class="todo-keyword TODO">TODO</span> 用 Bundler 管理 Gem 依赖</h3>
<h3 id="sec-7-4">
<span class="heading-number heading-number-2">7.4</span> <span class="todo-keyword TODO">TODO</span> 为 Gem 依赖设定版本上限</h3>
<h2 id="sec-8">
<span class="heading-number heading-number-1">8</span> 内存管理与性能 [0/5]</h2>
<h3 id="sec-8-1">
<span class="heading-number heading-number-2">8.1</span> <span class="todo-keyword TODO">TODO</span> 熟悉 Ruby 的垃圾收集器</h3>
<h3 id="sec-8-2">
<span class="heading-number heading-number-2">8.2</span> <span class="todo-keyword TODO">TODO</span> 用 Finalizer 构建资源安全网</h3>
<h3 id="sec-8-3">
<span class="heading-number heading-number-2">8.3</span> <span class="todo-keyword TODO">TODO</span> 认识 Ruby 性能分析工具</h3>
<h3 id="sec-8-4">
<span class="heading-number heading-number-2">8.4</span> <span class="todo-keyword TODO">TODO</span> 避免在循环中使用对象字面量</h3>
<h3 id="sec-8-5">
<span class="heading-number heading-number-2">8.5</span> <span class="todo-keyword TODO">TODO</span> 考虑记忆化大开销计算</h3>
</article>
          <aside class="col-md-3 sidebar-toc">
            <nav class="notes-sidebar  hidden-xs hidden-sm" id="notes-sidebar"><ul class="nav nav-stacked fixed">
<li>
<a href="#sec-1">
1 &#x8BA9;&#x81EA;&#x5DF1;&#x719F;&#x6089; Ruby</a><ul class="nav nav-stacked">
<li><a href="#sec-1-1">
1.1 &#x7406;&#x89E3; Ruby &#x4E2D;&#x7684; True</a></li>
<li><a href="#sec-1-2">
1.2 &#x6240;&#x6709;&#x5BF9;&#x8C61;&#x7684;&#x503C;&#x90FD;&#x53EF;&#x80FD;&#x4E3A; nil</a></li>
<li><a href="#sec-1-3">
1.3 &#x907F;&#x514D;&#x4F7F;&#x7528; Ruby &#x4E2D;&#x53E4;&#x602A;&#x7684; Perl &#x98CE;&#x683C;&#x8BED;&#x6CD5;</a></li>
<li><a href="#sec-1-4">
1.4 &#x7559;&#x795E;&#xFF0C;&#x5E38;&#x91CF;&#x662F;&#x53EF;&#x53D8;&#x7684;</a></li>
<li><a href="#sec-1-5">
1.5 &#x7559;&#x610F;&#x8FD0;&#x884C;&#x65F6;&#x8B66;&#x544A;</a></li>
</ul>
</li>
<li>
<a href="#sec-2">
2 &#x7C7B;&#x3001;&#x5BF9;&#x8C61;&#x548C;&#x6A21;&#x5757;</a><ul class="nav nav-stacked">
<li><a href="#sec-2-1">
2.1 &#x4E86;&#x89E3; Ruby &#x5982;&#x4F55;&#x6784;&#x5EFA;&#x7EE7;&#x627F;&#x4F53;&#x7CFB;</a></li>
<li><a href="#sec-2-2">
2.2 &#x4E86;&#x89E3; super &#x7684;&#x4E0D;&#x540C;&#x884C;&#x4E3A;</a></li>
<li><a href="#sec-2-3">
2.3 &#x521D;&#x59CB;&#x5316;&#x5B50;&#x7C7B;&#x65F6;&#x8C03;&#x7528; super</a></li>
<li><a href="#sec-2-4">
2.4 &#x63D0;&#x9632; Ruby &#x6700;&#x68D8;&#x624B;&#x7684;&#x89E3;&#x6790;</a></li>
<li><a href="#sec-2-5">
2.5 &#x63A8;&#x8350;&#x4F7F;&#x7528; Struct &#x800C;&#x975E; Hash &#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x5316;&#x6570;&#x636E;</a></li>
<li><a href="#sec-2-6">
2.6 &#x901A;&#x8FC7;&#x5728;&#x6A21;&#x5757;&#x4E2D;&#x5D4C;&#x5165;&#x4EE3;&#x7801;&#x6765;&#x521B;&#x5EFA;&#x547D;&#x540D;&#x7A7A;&#x95F4;</a></li>
<li><a href="#sec-2-7">
2.7 &#x7406;&#x89E3;&#x7B49;&#x4EF7;&#x7684;&#x4E0D;&#x540C;&#x7528;&#x6CD5;</a></li>
<li><a href="#sec-2-8">
2.8 &#x901A;&#x8FC7;&#x201D;&lt;=&gt;&#x201D;&#x64CD;&#x4F5C;&#x7B26;&#x5B9E;&#x73B0;&#x6BD4;&#x8F83;&#x548C;&#x6BD4;&#x8F83;&#x6A21;&#x5757;</a></li>
<li><a href="#sec-2-9">
2.9 &#x901A;&#x8FC7; protected &#x65B9;&#x6CD5;&#x5171;&#x4EAB;&#x79C1;&#x6709;&#x72B6;&#x6001;</a></li>
<li><a href="#sec-2-10">
2.10 &#x4F18;&#x5148;&#x4F7F;&#x7528;&#x5B9E;&#x4F8B;&#x53D8;&#x91CF;&#x800C;&#x975E;&#x7C7B;&#x53D8;&#x91CF;</a></li>
</ul>
</li>
<li>
<a href="#sec-3">
3 &#x96C6;&#x5408;</a><ul class="nav nav-stacked">
<li><a href="#sec-3-1">
3.1 &#x5728;&#x6539;&#x53D8;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x7684;&#x96C6;&#x5408;&#x4E4B;&#x524D;&#x590D;&#x5236;&#x5B83;&#x4EEC;</a></li>
<li><a href="#sec-3-2">
3.2 &#x4F7F;&#x7528; Array &#x65B9;&#x6CD5;&#x5C06; nil &#x53CA;&#x6807;&#x91CF;&#x5BF9;&#x8C61;&#x8F6C;&#x6362;&#x6210;&#x6570;&#x7EC4;</a></li>
<li><a href="#sec-3-3">
3.3 &#x8003;&#x8651;&#x4F7F;&#x7528;&#x96C6;&#x5408;&#x9AD8;&#x6548;&#x68C0;&#x67E5;&#x5143;&#x7D20;&#x7684;&#x5305;&#x542B;&#x6027;</a></li>
<li><a href="#sec-3-4">
3.4 &#x4E86;&#x89E3;&#x5982;&#x4F55;&#x901A;&#x8FC7; reduce &#x65B9;&#x6CD5;&#x6298;&#x53E0;&#x96C6;&#x5408;</a></li>
<li><a href="#sec-3-5">
3.5 &#x8003;&#x8651;&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;&#x54C8;&#x5E0C;&#x503C;</a></li>
<li><a href="#sec-3-6">
3.6 &#x5BF9;&#x96C6;&#x5408;&#x4F18;&#x5148;&#x4F7F;&#x7528;&#x59D4;&#x6258;&#x800C;&#x975E;&#x7EE7;&#x627F;</a></li>
</ul>
</li>
<li>
<a href="#sec-4">
4 &#x5F02;&#x5E38;</a><ul class="nav nav-stacked">
<li><a href="#sec-4-1">
4.1 &#x4F7F;&#x7528;&#x5B9A;&#x5236;&#x7684;&#x5F02;&#x5E38;&#x800C;&#x4E0D;&#x662F;&#x629B;&#x51FA;&#x5B57;&#x7B26;&#x4E32;</a></li>
<li><a href="#sec-4-2">
4.2 &#x901A;&#x8FC7;&#x5757;&#x548C; ensure &#x7BA1;&#x7406;&#x8D44;&#x6E90;</a></li>
<li><a href="#sec-4-3">
4.3 &#x901A;&#x8FC7;&#x4E34;&#x8FD1;&#x7684; end &#x9000;&#x51FA; ensure &#x8BED;&#x53E5;</a></li>
<li><a href="#sec-4-4">
4.4 &#x9650;&#x5236; retry &#x6B21;&#x6570;&#xFF0C;&#x6539;&#x53D8;&#x91CD;&#x8BD5;&#x9891;&#x7387;&#x5E76;&#x8BB0;&#x5F55;&#x5F02;&#x5E38;&#x4FE1;&#x606F;</a></li>
<li><a href="#sec-4-5">
4.5 throw &#x6BD4; raise &#x66F4;&#x9002;&#x5408;&#x7528;&#x6765;&#x8DF3;&#x51FA;&#x4F5C;&#x7528;&#x57DF;</a></li>
</ul>
</li>
<li>
<a href="#sec-5">
5 &#x5143;&#x7F16;&#x7A0B; [0/8]</a><ul class="nav nav-stacked">
<li><a href="#sec-5-1">
5.1 TODO &#x719F;&#x6089; Ruby &#x6A21;&#x5757;&#x548C;&#x7C7B;&#x7684;&#x94A9;&#x5B50;&#x65B9;&#x6CD5;</a></li>
<li><a href="#sec-5-2">
5.2 TODO &#x5728;&#x7C7B;&#x7684;&#x94A9;&#x5B50;&#x65B9;&#x6CD5;&#x4E2D;&#x6267;&#x884C; super &#x65B9;&#x6CD5;</a></li>
<li><a href="#sec-5-3">
5.3 TODO &#x63A8;&#x8350;&#x4F7F;&#x7528; define_method &#x800C;&#x975E; method_missing</a></li>
<li><a href="#sec-5-4">
5.4 TODO &#x4E86;&#x89E3;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684; eval &#x95F4;&#x7684;&#x5DEE;&#x5F02;</a></li>
<li><a href="#sec-5-5">
5.5 TODO &#x614E;&#x7528;&#x7334;&#x5B50;&#x8865;&#x4E01;</a></li>
<li><a href="#sec-5-6">
5.6 TODO &#x4F7F;&#x7528;&#x522B;&#x540D;&#x94FE;&#x6267;&#x884C;&#x88AB;&#x4FEE;&#x6539;&#x7684;&#x65B9;&#x6CD5;</a></li>
<li><a href="#sec-5-7">
5.7 TODO &#x652F;&#x6301;&#x591A;&#x79CD; Proc &#x53C2;&#x6570;&#x6570;&#x91CF;</a></li>
<li><a href="#sec-5-8">
5.8 TODO &#x4F7F;&#x7528;&#x6A21;&#x5757;&#x524D;&#x7F6E;&#x65F6;&#x8BF7;&#x8C28;&#x614E;&#x601D;&#x8003;</a></li>
</ul>
</li>
<li>
<a href="#sec-6">
6 &#x6D4B;&#x8BD5; [0/4]</a><ul class="nav nav-stacked">
<li><a href="#sec-6-1">
6.1 TODO &#x719F;&#x6089;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x5DE5;&#x5177; MiniTest</a></li>
<li><a href="#sec-6-2">
6.2 TODO &#x719F;&#x6089; MiniTest &#x7684;&#x9700;&#x6C42;&#x6D4B;&#x8BD5;</a></li>
<li><a href="#sec-6-3">
6.3 TODO &#x4F7F;&#x7528; Mock &#x6A21;&#x62DF;&#x7279;&#x5B9A;&#x5BF9;&#x8C61;</a></li>
<li><a href="#sec-6-4">
6.4 TODO &#x529B;&#x4E89;&#x4EE3;&#x7801;&#x88AB;&#x6709;&#x6548;&#x6D4B;&#x8BD5;&#x8FC7;</a></li>
</ul>
</li>
<li>
<a href="#sec-7">
7 &#x5DE5;&#x5177;&#x4E0E;&#x5E93; [0/4]</a><ul class="nav nav-stacked">
<li><a href="#sec-7-1">
7.1 TODO &#x5B66;&#x4F1A;&#x4F7F;&#x7528; Ruby &#x6587;&#x6863;</a></li>
<li><a href="#sec-7-2">
7.2 TODO &#x8BA4;&#x8BC6; IRB &#x7684;&#x9AD8;&#x7EA7;&#x7279;&#x6027;</a></li>
<li><a href="#sec-7-3">
7.3 TODO &#x7528; Bundler &#x7BA1;&#x7406; Gem &#x4F9D;&#x8D56;</a></li>
<li><a href="#sec-7-4">
7.4 TODO &#x4E3A; Gem &#x4F9D;&#x8D56;&#x8BBE;&#x5B9A;&#x7248;&#x672C;&#x4E0A;&#x9650;</a></li>
</ul>
</li>
<li>
<a href="#sec-8">
8 &#x5185;&#x5B58;&#x7BA1;&#x7406;&#x4E0E;&#x6027;&#x80FD; [0/5]</a><ul class="nav nav-stacked">
<li><a href="#sec-8-1">
8.1 TODO &#x719F;&#x6089; Ruby &#x7684;&#x5783;&#x573E;&#x6536;&#x96C6;&#x5668;</a></li>
<li><a href="#sec-8-2">
8.2 TODO &#x7528; Finalizer &#x6784;&#x5EFA;&#x8D44;&#x6E90;&#x5B89;&#x5168;&#x7F51;</a></li>
<li><a href="#sec-8-3">
8.3 TODO &#x8BA4;&#x8BC6; Ruby &#x6027;&#x80FD;&#x5206;&#x6790;&#x5DE5;&#x5177;</a></li>
<li><a href="#sec-8-4">
8.4 TODO &#x907F;&#x514D;&#x5728;&#x5FAA;&#x73AF;&#x4E2D;&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x5B57;&#x9762;&#x91CF;</a></li>
<li><a href="#sec-8-5">
8.5 TODO &#x8003;&#x8651;&#x8BB0;&#x5FC6;&#x5316;&#x5927;&#x5F00;&#x9500;&#x8BA1;&#x7B97;</a></li>
</ul>
</li>
</ul></nav>
          </aside>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">Contributes &amp; License</div>
    </footer>
    <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf-8">
     $('#notes-sidebar').affix({
       offset: {
         top: $('#notes-sidebar').offset().top,
         bottom: ($('footer').outerHeight(true))
       }
     });
    </script>
  </body>
</html>
