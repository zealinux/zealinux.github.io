<!DOCTYPE html>
<html lang="zh-CN">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>Document</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.css" rel="stylesheet">
    <link href="/abc.css" rel="stylesheet">
  </head>

  <body data-spy="scroll" data-target=".notes-sidebar">
    <header>
      <div class="notes-header">
        <div class="container">
          <div class="row">
            <div class="col-md-9">
              <h1>改善 Ruby 程序的 48 条建议</h1>
            </div>
            <div class="col-md-3">
              <a href="/">
                <img alt="" src="http://placehold.it/150x120?text=INDEX">
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div class="container notes-content">
        <div class="row">
          <article class="col-md-9">
<h2 id="sec-1">
<span class="heading-number heading-number-1">1</span> 让自己熟悉 Ruby</h2>
<h3 id="sec-1-1">
<span class="heading-number heading-number-2">1.1</span> 理解 Ruby 中的 True</h3>
<ul>
  <li>除了 <code>false</code> 和 <code>nil</code> 外，其他都是真值</li>
  <li>区分 false 和 nil 的方法</li>
</ul>
<pre class="src" lang="ruby">
x.nil?
<span style="color:#069">false</span> == x
</pre>
<h3 id="sec-1-2">
<span class="heading-number heading-number-2">1.2</span> 所有对象的值都可能为 nil</h3>
<ul>
  <li>下面两行等价</li>
</ul>
<pre class="src" lang="ruby">
person.save <span style="color:#080;font-weight:bold">if</span> person
person.save <span style="color:#080;font-weight:bold">if</span> !person.nil?
</pre>
<h3 id="sec-1-3">
<span class="heading-number heading-number-2">1.3</span> 避免使用 Ruby 中古怪的 Perl 风格语法</h3>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">if</span> message =~ <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">^ERROR: </span><span style="color:#D20">\s</span><span style="color:#808">+(.+)$</span><span style="color:#404">/</span></span>; <span style="color:#d70">$1</span> <span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good use MatchData</span>
<span style="color:#080;font-weight:bold">if</span> m = message.match(<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">^ERROR: </span><span style="color:#D20">\s</span><span style="color:#808">+(.+)$</span><span style="color:#404">/</span></span>); m[<span style="color:#00D">1</span>] <span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># bad</span>
<span style="color:#d70">$:</span>  <span style="color:#777">#=&gt; $LOAD_PATH</span>
</pre>
<h3 id="sec-1-4">
<span class="heading-number heading-number-2">1.4</span> 留神，常量是可变的</h3>
<ul>
  <li>全部冻结（集合对象及元素）</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">Defaults</span>
  <span style="color:#036;font-weight:bold">NETWORKS</span> = [
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">192.168.1.1</span><span style="color:#710">'</span></span>
  ].map!(&amp;<span style="color:#A60">:freeze</span>).freeze
<span style="color:#080;font-weight:bold">end</span>

</pre>
<h3 id="sec-1-5">
<span class="heading-number heading-number-2">1.5</span> 留意运行时警告</h3>
<ul>
  <li>ruby -w</li>
  <li>$VERBOSE</li>
  <li>t.warning = true  # in Rakefile</li>
</ul>
<h2 id="sec-2">
<span class="heading-number heading-number-1">2</span> 类、对象和模块</h2>
<h3 id="sec-2-1">
<span class="heading-number heading-number-2">2.1</span> 了解 Ruby 如何构建继承体系</h3>
<h4 id="sec-2-1-1">
<span class="heading-number heading-number-3">2.1.1</span> 对象、类、模块</h4>
<blockquote>
  <ul>
    <li>对象是变量的容器
      这些对象被称为 <b>实例变量</b> 代表这对象的状态
      对象有一个特殊的内部变量链接唯一的一个类 （TODO）</li>
    <li>类是方法和常量的容器
      <b>实例方法</b> 代表类所有对象的行为
      类也是对象，则类也是类变量的容器
      类是一种器变量称为类变量，其方法称为类方法的对象。</li>
    <li>模块和类相似，除了不能实例化以及更严格的语法。
      可以将模块 <code>include</code> 进类，实现多重继承的效果。</li>
    <li>单件类（singleton）是继承体系中的一个匿名且不可见的类。
      （有时也称 eigenclasses/metaclasses）
      提供了存储类方法和从 modules 中引入的方法的空间
      与常规类不同，它们是动态创建的，不能被实例化。
      单件类不同于常规类奉献精神 - 所有对象都可以使用方法，单件类只服务一个对象。
      类方法是作为单件类的实例方法存储的。</li>
    <li>接收者是调用方法的对象。
      <code>foo.name</code> 接收者是 foo，当 name 方法执行时，self 变量被设置在 foo 上。
      方法省略时，隐式将 <code>self</code> 设置成当前上下文</li>
  </ul>
</blockquote>
<h4 id="sec-2-1-2">
<span class="heading-number heading-number-3">2.1.2</span> 继承体系</h4>
<ul>
  <li>Foo/Object/Kernel/BasicObject</li>
  <li>只使用 <code>superclass</code> 时会省略 module 比如 kernel</li>
</ul>
<h4 id="sec-2-1-3">
<span class="heading-number heading-number-3">2.1.3</span> 引入模块时发生的事情</h4>
<ul>
  <li>创建一个单件类并插入类继承体系中。（共享实例方法和常量）</li>
  <li>include 后插入到当前类的上方，查找方法时（后进先出 LIFO）优先级仅次于当前类</li>
</ul>
<h4 id="sec-2-1-4">
<span class="heading-number heading-number-3">2.1.4</span> 查找方法</h4>
<ol>
  <li>找到接收者的类</li>
  <li>查找该类中存储的实例方法列表，找到就停止并执行代码</li>
  <li>顺着继承体系找到超类（包括超类是单件类），并重复第 2 步</li>
  <li>重复 2，3 直到抵达体系的根（*BasicObject*）</li>
  <li>找不到方法，就重头开始找方法 <code>method_missing</code>
</li>
</ol>
<h4 id="sec-2-1-5">
<span class="heading-number heading-number-3">2.1.5</span> 有用的方法</h4>
<ul>
  <li>singleton_class.instance_method(false)
    <ul>
      <li>#<a href="Class:Foo">Class:Foo</a>
</li>
    </ul>
  </li>
  <li>ancestors</li>
  <li>included_modules</li>
</ul>
<h3 id="sec-2-2">
<span class="heading-number heading-number-2">2.2</span> 了解 super 的不同行为</h3>
<ul>
  <li>三种 <b>super</b> (关键字)行为</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">foo</span>(x, y)
  <span style="color:#080;font-weight:bold">super</span>(<span style="color:#00D">1</span>,<span style="color:#00D">2</span>)
  <span style="color:#080;font-weight:bold">super</span>     <span style="color:#777">#=&gt; super(x, y)</span>
  <span style="color:#080;font-weight:bold">super</span>()   <span style="color:#777">#无参数</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<ul>
  <li>super 可以调用引入模块的方法</li>
</ul>
<h3 id="sec-2-3">
<span class="heading-number heading-number-2">2.3</span> 初始化子类时调用 super</h3>
<ul>
  <li>如要显示使用继承的定义 initialize 方法时，需要使用 super 来初始化其父类</li>
</ul>
<h3 id="sec-2-4">
<span class="heading-number heading-number-2">2.4</span> 提防 Ruby 最棘手的解析</h3>
<h4 id="sec-2-4-1">
<span class="heading-number heading-number-3">2.4.1</span> setter 方法在调用时需要显式的接收者，否则被解析成变量赋值</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Counter</span>
  attr_accessor <span style="color:#A60">:counter</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>
    counter =  <span style="color:#00D">0</span>  <span style="color:#777"># local variale assign</span>
    <span style="color:#069">self</span>.counter = <span style="color:#00D">0</span>  <span style="color:#777"># right</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">bar</span>
    counter + <span style="color:#00D">1</span>  <span style="color:#777"># right = self.counter + 1</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</pre>
<h3 id="sec-2-5">
<span class="heading-number heading-number-2">2.5</span> 推荐使用 Struct 而非 Hash 存储结构化数据</h3>
<h4 id="sec-2-5-1">
<span class="heading-number heading-number-3">2.5.1</span> 不应该将 hash 数组通过公共接口向外暴露</h4>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AnnualWeather</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(file_name)
    <span style="color:#33B">@readings</span> =  []

    <span style="color:#036;font-weight:bold">CSV</span>.foreach(file_name, <span style="color:#606">headers</span>: <span style="color:#069">true</span>) <span style="color:#080;font-weight:bold">do</span> |row|
      <span style="color:#33B">@readings</span> &lt;&lt; {
        <span style="color:#606">date</span>: <span style="color:#036;font-weight:bold">Date</span>.parse(row[<span style="color:#00D">2</span>]),
        <span style="color:#606">high</span>: row[<span style="color:#00D">10</span>].to_f,
        <span style="color:#606">low</span>: row[<span style="color:#00D">11</span>].to_f
      }
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">mean</span>
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#60E">0.0</span> <span style="color:#080;font-weight:bold">if</span> <span style="color:#33B">@readings</span>.size.zero?

    total = <span style="color:#33B">@readings</span>.reduce(<span style="color:#60E">0.0</span>) <span style="color:#080;font-weight:bold">do</span> |sum, reading|
      sum + (reading[<span style="color:#A60">:high</span>] + reading[<span style="color:#A60">:low</span>]) / <span style="color:#60E">2.0</span>
    <span style="color:#080;font-weight:bold">end</span>

    total / <span style="color:#33B">@readings</span>.size.to_f
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AnnualWeather</span>
  <span style="color:#036;font-weight:bold">Reading</span> = <span style="color:#036;font-weight:bold">Struct</span>.new(<span style="color:#A60">:date</span>, <span style="color:#A60">:high</span>, <span style="color:#A60">:low</span>) <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">mean</span> <span style="color:#777"># struct object method</span>
      (high + low) / <span style="color:#60E">2.0</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(file_name)
    <span style="color:#33B">@readings</span> =  []

    <span style="color:#036;font-weight:bold">CSV</span>.foreach(file_name, <span style="color:#606">headers</span>: <span style="color:#069">true</span>) <span style="color:#080;font-weight:bold">do</span> |row|
      <span style="color:#33B">@readings</span> &lt;&lt; <span style="color:#036;font-weight:bold">Reading</span>.new(<span style="color:#036;font-weight:bold">Date</span>.parse(row[<span style="color:#00D">2</span>]), row[<span style="color:#00D">10</span>].to_f, row[<span style="color:#00D">11</span>].to_f)
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">mean</span>
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#60E">0.0</span> <span style="color:#080;font-weight:bold">if</span> <span style="color:#33B">@readings</span>.size.zero?

    total = <span style="color:#33B">@readings</span>.reduce(<span style="color:#60E">0.0</span>) <span style="color:#080;font-weight:bold">do</span> |sum, reading|
      sum + <span style="color:#036;font-weight:bold">Reading</span>.new(reading.high, reading.low).mean  <span style="color:#777"># awsome</span>
    <span style="color:#080;font-weight:bold">end</span>

    total / <span style="color:#33B">@readings</span>.size.to_f
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</pre>
<ul>
  <li>结构化数据时，如果创建一个新类不合适，推荐使用 Struct 而非 Hash</li>
</ul>
<h3 id="sec-2-6">
<span class="heading-number heading-number-2">2.6</span> 通过在模块中嵌入代码来创建命名空间</h3>
<h4 id="sec-2-6-1">
<span class="heading-number heading-number-3">2.6.1</span> module 可以做命令空间，以便方法隔离</h4>
<h4 id="sec-2-6-2">
<span class="heading-number heading-number-3">2.6.2</span> module 词法作用域</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">Foo</span>
  <span style="color:#036;font-weight:bold">KEY</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">passoword</span><span style="color:#710">'</span></span>

  <span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Bar</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(key = <span style="color:#036;font-weight:bold">KEY</span>)  <span style="color:#777"># right</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">Foo</span>
  <span style="color:#036;font-weight:bold">KEY</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">passoword</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span> <span style="color:#777"># 词法作用域关闭</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Bar</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(key = <span style="color:#036;font-weight:bold">KEY</span>)  <span style="color:#777"># Nameerror, use Foo::KEY</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<pre class="src" lang="ruby">
<span style="color:#036;font-weight:bold">Foo</span>::<span style="color:#036;font-weight:bold">Bar</span>
::<span style="color:#036;font-weight:bold">Bar</span>  <span style="color:#777"># 顶级空间</span>
</pre>
<blockquote>
  <p>模块名（常量）可以看作全局常量，这时所有顶级常量都被存在 <b>Object</b> 类中。
    所以查找方式：</p>
  <ul>
    <li>当前词法作用域</li>
    <li>继承体系</li>
  </ul>
</blockquote>
<h3 id="sec-2-7">
<span class="heading-number heading-number-2">2.7</span> 理解等价的不同用法</h3>
<h4 id="sec-2-7-1">
<span class="heading-number heading-number-3">2.7.1</span> 四种等价比较</h4>
<table>
  <tr>
<th></th>
<th>含义</th>
<th>应用场景</th>
<th>举例</th>
<th>附注</th>
</tr>
  <tr>
<td>==</td>
<td>值相等</td>
<td></td>
<td><code>1 == 1.0</code></td>
<td>类型隐式转换</td>
</tr>
  <tr>
<td>equal?</td>
<td>同一对象</td>
<td>检查两个对象是否指向内存同一块</td>
<td></td>
<td>除了数字，其他都是引用</td>
</tr>
  <tr>
<td>eql?</td>
<td>Hash 的键比较</td>
<td>Hash 类中比较对象的 Key</td>
<td></td>
<td></td>
</tr>
  <tr>
<td>===</td>
<td>case 等价</td>
<td>case when 条件中隐式调用</td>
<td></td>
<td></td>
</tr>
</table>
<h4 id="sec-2-7-2">
<span class="heading-number heading-number-3">2.7.2</span> eql? 示例</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Color</span>
  attr_reader <span style="color:#A60">:name</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(name)
    <span style="color:#33B">@name</span> = name
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">hash</span>
    name.hash
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">eql?</span>(other)
    name.eql?(other.name)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

a = <span style="color:#036;font-weight:bold">Color</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">pink</span><span style="color:#710">'</span></span>)
b = <span style="color:#036;font-weight:bold">Color</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">pink</span><span style="color:#710">'</span></span>)

{a =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">like</span><span style="color:#710">'</span></span>, b =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">love</span><span style="color:#710">'</span></span> }  
<span style="color:#777">#=&gt; {#&lt;Color:0x007fa74586a288 @name="pink"&gt;=&gt;"love"}</span>
</pre>
<h4 id="sec-2-7-3">
<span class="heading-number heading-number-3">2.7.3</span> === 示例</h4>
<ul>
  <li>case 之后的表达式总是出现在 <code>===</code> 的右侧</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">case</span> command
<span style="color:#080;font-weight:bold">when</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">start</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">then</span> start
<span style="color:#080;font-weight:bold">when</span> <span style="color:#036;font-weight:bold">Numeric</span> <span style="color:#080;font-weight:bold">then</span> timer(command)
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># ===</span>
<span style="color:#080;font-weight:bold">if</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">start</span><span style="color:#710">'</span></span> === command <span style="color:#080;font-weight:bold">then</span> start
<span style="color:#080;font-weight:bold">elsif</span> <span style="color:#036;font-weight:bold">Numeric</span> === command <span style="color:#080;font-weight:bold">then</span> timer(command)
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h4 id="sec-2-7-4">
<span class="heading-number heading-number-3">2.7.4</span> Regexp#== vs String#===</h4>
<pre class="src" lang="ruby">
<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">er</span><span style="color:#404">/</span></span> === <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Tyler</span><span style="color:#710">'</span></span>
<span style="color:#777">#=&gt; true</span>

<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Tyler</span><span style="color:#710">'</span></span> == <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">er</span><span style="color:#404">/</span></span>
<span style="color:#777">#=&gt; false</span>
</pre>
<h4 id="sec-2-7-5">
<span class="heading-number heading-number-3">2.7.5</span> is_a? vs ===</h4>
<pre class="src" lang="ruby">
[<span style="color:#00D">1</span>, <span style="color:#00D">2</span>, <span style="color:#00D">3</span>].is_a?(<span style="color:#036;font-weight:bold">Array</span>)

<span style="color:#036;font-weight:bold">Array</span> === [<span style="color:#00D">1</span>, <span style="color:#00D">2</span>, <span style="color:#00D">3</span>]
</pre>
<h3 id="sec-2-8">
<span class="heading-number heading-number-2">2.8</span> 通过”&lt;=&gt;”操作符实现比较和比较模块</h3>
<ul>
  <li>hash ?</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#777"># coding: utf-8</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Version</span>
  include <span style="color:#036;font-weight:bold">Comparable</span>  <span style="color:#777"># &gt;,&lt; etc.</span>
  attr_reader <span style="color:#A60">:major</span>, <span style="color:#A60">:minor</span>, <span style="color:#A60">:patch</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(version)
    <span style="color:#33B">@major</span>, <span style="color:#33B">@minor</span>, <span style="color:#33B">@patch</span> = version.split(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">.</span><span style="color:#710">'</span></span>).map(&amp;<span style="color:#A60">:to_i</span>)
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">&lt;=&gt;</span>(other)
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">nil</span> <span style="color:#080;font-weight:bold">unless</span> other.is_a?(<span style="color:#036;font-weight:bold">Version</span>)

    [major &lt;=&gt; other.major,
     minor &lt;=&gt; other.minor,
     patch &lt;=&gt; other.patch
    ].detect { |n| !n.zero? } || <span style="color:#00D">0</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#777"># 定义 hash 方法</span>
  alias_method <span style="color:#A60">:eql?</span>, <span style="color:#A60">:==</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">hash</span>
    [major, minor, patch].hash
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

vs = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%w(</span><span style="color:#D20"> 1.0.0 1.11.1 1.9.0</span><span style="color:#710">)</span></span>.map {|v| <span style="color:#036;font-weight:bold">Version</span>.new(v)}
vs.sort
</pre>
<h3 id="sec-2-9">
<span class="heading-number heading-number-2">2.9</span> 通过 protected 方法共享私有状态</h3>
<h4 id="sec-2-9-1">
<span class="heading-number heading-number-3">2.9.1</span> protected 方法共享私有状态（相关类 - 同一类或超类）</h4>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Widget</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">overlapping?</span>(other)
    x1, y1 = <span style="color:#33B">@screen_x</span>, <span style="color:#33B">@screen_y</span>
    x2, y2 = other.instance_eval { [<span style="color:#33B">@screen_x</span>, <span style="color:#33B">@screen_y</span>] }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Widget</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">overlapping?</span>(other)
    x1, y1 = screen_coordinates
    x2, y2 = other.screen_coordinates
  <span style="color:#080;font-weight:bold">end</span>

  protected
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">screen_coordinates</span>
    [<span style="color:#33B">@screen_x</span>, <span style="color:#33B">@screen_y</span>]
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-2-10">
<span class="heading-number heading-number-2">2.10</span> 优先使用实例变量而非类变量</h3>
<ul>
  <li>实例变量 - 子类独一份</li>
  <li>类变量 - 子类共一份</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#777"># coding: utf-8</span>
<span style="color:#777"># error</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Singleton</span>
  private_class_method <span style="color:#A60">:new</span>, <span style="color:#A60">:dup</span>, <span style="color:#A60">:clone</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">instance</span>
    <span style="color:#369">@@single</span> ||= new  <span style="color:#777"># 超类的类变量被所有子类共享</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Configuration</span> &lt; <span style="color:#036;font-weight:bold">Singleton</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Database</span> &lt; <span style="color:#036;font-weight:bold">Singleton</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">Configuration</span>.instance  <span style="color:#777">#=&gt; #&lt;Configuration&gt;</span>
<span style="color:#036;font-weight:bold">Database</span>.instance  <span style="color:#777">#=&gt; #&lt;Configuration&gt;</span>

<span style="color:#777"># right</span>
<span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">instance</span>
  <span style="color:#33B">@single</span> ||= new
<span style="color:#080;font-weight:bold">end</span>
</pre>
<blockquote>
  <p>类方法实际上就是类对象的实例方法</p>
</blockquote>
<h4 id="sec-2-10-1">
<span class="heading-number heading-number-3">2.10.1</span> 线程安全单键模式</h4>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">singleton</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">Configuration</span>
  include <span style="color:#036;font-weight:bold">Singleton</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h2 id="sec-3">
<span class="heading-number heading-number-1">3</span> 集合</h2>
<ul>
  <li>Array, Hash, Set</li>
</ul>
<h3 id="sec-3-1">
<span class="heading-number heading-number-2">3.1</span> 在改变作为参数的集合之前复制它们</h3>
<blockquote>
  <p>集合类实际存储对象的引用，除了 Fixnum
    方法参数也类似</p>
</blockquote>
<ul>
  <li>delete vs reject</li>
</ul>
<h4 id="sec-3-1-1">
<span class="heading-number heading-number-3">3.1.1</span> dup vs clone</h4>
<blockquote>
  <p>clone 会保留原始对象的两个附加特性（freeze, 存在单件类）</p>
</blockquote>
<h4 id="sec-3-1-2">
<span class="heading-number heading-number-3">3.1.2</span> 拷贝</h4>
<table>
  <tr>
<th></th>
<th>类型</th>
<th>缺点</th>
<th>说明</th>
</tr>
  <tr>
<td>dup</td>
<td>浅拷贝</td>
<td></td>
<td>只复制了容器本身</td>
</tr>
  <tr>
<td>clone</td>
<td></td>
<td></td>
<td></td>
</tr>
  <tr>
<td>Mashal</td>
<td>深拷贝</td>
<td>消耗内存/有些类不能序列化（IO/File）</td>
<td>包括了其中的元素</td>
    <ul>
      <li>可以重写 <code>initialize_copy</code> 控制赋值过程的深度</li>
    </ul>
  </tr>
</table>
<h3 id="sec-3-2">
<span class="heading-number heading-number-2">3.2</span> 使用 Array 方法将 nil 及标量对象转换成数组</h3>
<pre class="src" lang="ruby">
Array(<span style="color:#069">nil</span>)  <span style="color:#777">#=&gt; []</span>
Array({ <span style="color:#606">a</span>: <span style="color:#00D">1</span> })  <span style="color:#777">#=&gt; [[:a, 1]] 反转用 Hash[]</span>
</pre>
<h3 id="sec-3-3">
<span class="heading-number heading-number-2">3.3</span> 考虑使用集合高效检查元素的包含性</h3>
<p>Ruby 自带两套库：</p>
<ul>
  <li>核心库已经预先加载</li>
  <li>标准库，比如：Set</li>
</ul>
<h4 id="sec-3-3-1">
<span class="heading-number heading-number-3">3.3.1</span> Set 使用</h4>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Role</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(name, permissions)
    <span style="color:#33B">@name</span>, <span style="color:#33B">@permissions</span> = name, permissions  <span style="color:#777"># bad</span>
    <span style="color:#777"># @permissions = Hash[permissions.map { |p| [p, true] }]  # litter better</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">can?</span>(permission)
    <span style="color:#33B">@permissions</span>.include?(permission)  <span style="color:#777"># Array O(n); Hash O(logn)</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">set</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Role</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(name, permissions)
    <span style="color:#33B">@name</span>, <span style="color:#33B">@permissions</span> = name, <span style="color:#036;font-weight:bold">Set</span>.new(permissions)  <span style="color:#777"># O(logn)</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<blockquote>
  <p><b>Set</b> 是无序的容器，若要有序的使用 <b>SortedSet</b></p>
</blockquote>
<h3 id="sec-3-4">
<span class="heading-number heading-number-2">3.4</span> 了解如何通过 reduce 方法折叠集合</h3>
<h4 id="sec-3-4-1">
<span class="heading-number heading-number-3">3.4.1</span> reduce 函数由三部分组成：</h4>
<ul>
  <li>枚举的对象是接收者（比如引入 <b>Enumberable</b> ）</li>
  <li>每个元素调用一次，每次都有返回值，这个返回值代表最终生成的数据结构</li>
  <li>初始对象（累加器），一次块的调用都会接受当前累加器的值并返回新的累加器值
    <ul>
      <li>参数是累加器的初始值（枚举类型为空，则返回这个值）</li>
    </ul>
  </li>
</ul>
<h4 id="sec-3-4-2">
<span class="heading-number heading-number-3">3.4.2</span> 应用</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">sum</span>(enum)
  enum.reduce(<span style="color:#00D">0</span>) <span style="color:#080;font-weight:bold">do</span> |accumulator, element| 
    accumulator + element
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">sum</span>(enum)
  enum.reduce(<span style="color:#00D">0</span>, <span style="color:#A60">:+</span>)
  <span style="color:#777"># enum.reduce(0, &amp;:+)</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">Hash</span>[array.map { |x| [x, <span style="color:#069">true</span>] }]

array.reduce({}) <span style="color:#080;font-weight:bold">do</span> |hash, element|
  hash.update(element =&gt; <span style="color:#069">true</span>)
  <span style="color:#777"># hash[element] = true</span>
  <span style="color:#777"># hash</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># bad</span>
users.select { |u| u.age &gt;= <span style="color:#00D">21</span> }.map(&amp;<span style="color:#A60">:name</span>)

<span style="color:#777"># good</span>
users.reduce([]) <span style="color:#080;font-weight:bold">do</span> |names, user|
  names &lt;&lt; user.name <span style="color:#080;font-weight:bold">if</span> user.age &gt;= <span style="color:#00D">21</span>
  names
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-3-5">
<span class="heading-number heading-number-2">3.5</span> 考虑使用默认哈希值</h3>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">frequency</span>(array)
  <span style="color:#777"># bad</span>
  array.reduce({}) <span style="color:#080;font-weight:bold">do</span> |hash, element|
    hash[element] ||= <span style="color:#00D">0</span>
    hash[element] += <span style="color:#00D">1</span>
    hash
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#777"># good</span>
  <span style="color:#777"># 0 默认值是没有找到才用到</span>
  array.reduce(<span style="color:#036;font-weight:bold">Hash</span>.new(<span style="color:#00D">0</span>)) <span style="color:#080;font-weight:bold">do</span> |hash, element|
    hash[element] += <span style="color:#00D">1</span>
    hash
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h4 id="sec-3-5-1">
<span class="heading-number heading-number-3">3.5.1</span> Hash.new</h4>
<pre class="src" lang="ruby">
h = <span style="color:#036;font-weight:bold">Hash</span>.new(<span style="color:#00D">42</span>)
h[<span style="color:#A60">:miss</span>]
h.keys <span style="color:#777">#=&gt; []</span>

h[<span style="color:#A60">:miss</span>] += <span style="color:#00D">1</span>
h.keys <span style="color:#777">#=&gt; [:miss]</span>

<span style="color:#777">#---------------</span>
h = <span style="color:#036;font-weight:bold">Hash</span>.new([])
h[<span style="color:#A60">:miss</span>]
h[<span style="color:#A60">:miss</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">hey</span><span style="color:#710">'</span></span>  <span style="color:#777"># 默认值改变</span>
h.keys <span style="color:#777">#=&gt; []</span>

h[<span style="color:#A60">:miss</span>] <span style="color:#777">#=&gt; ['key']</span>
h[<span style="color:#A60">:missd</span>] <span style="color:#777">#=&gt; ['key']</span>

h.default <span style="color:#777">#=&gt; ['key']</span>

<span style="color:#777">#---------------</span>
<span style="color:#777">## &lt;&lt; 两个键共享同一个默认数组</span>
h = <span style="color:#036;font-weight:bold">Hash</span>.new([])
h[<span style="color:#A60">:week</span>] = h[<span style="color:#A60">:week</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Monday</span><span style="color:#710">'</span></span>
h[<span style="color:#A60">:months</span>] = h[<span style="color:#A60">:months</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">January</span><span style="color:#710">'</span></span>
h.keys  <span style="color:#777">#=&gt; ['Monday', 'January']</span>

h[<span style="color:#A60">:week</span>] <span style="color:#777">#=&gt; ['Monday', 'January']</span>
h.default <span style="color:#777">#=&gt; ['Monday', 'January'] </span>

<span style="color:#777">#right</span>
h = <span style="color:#036;font-weight:bold">Hash</span>.new { [] }

<span style="color:#777"># better</span>
h = <span style="color:#036;font-weight:bold">Hash</span>.new { |hash, key| hash[key] = [] }
h[<span style="color:#A60">:week</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Monday</span><span style="color:#710">'</span></span>
h[<span style="color:#A60">:holidays</span>]  <span style="color:#777">#=&gt; []</span>
h.keys  <span style="color:#777">#=&gt; [:week, :holidays]</span>
</pre>
<p>Hash.new { [] }  # 当需要默认值时这个会被调用，并友好得返回一个新创建的数组</p>
<h4 id="sec-3-5-2">
<span class="heading-number heading-number-3">3.5.2</span> 使用 <code>has_key?</code> 来检测 hash 包含某个键</h4>
<h4 id="sec-3-5-3">
<span class="heading-number heading-number-3">3.5.3</span> 使用 fetch</h4>
<ul>
  <li>h.fetch(:week) - 当获取不存在的键，抛出异常(KeyError)</li>
  <li>h.fetch(:week, []) - 当获取不存在的键，用第二个参数代替</li>
</ul>
<h3 id="sec-3-6">
<span class="heading-number heading-number-2">3.6</span> 对集合优先使用委托而非继承</h3>
<ul>
  <li>委托 - 有一个（has a)</li>
  <li>继承 - 是一个（is a）</li>
</ul>
<h4 id="sec-3-6-1">
<span class="heading-number heading-number-3">3.6.1</span> 委托示例</h4>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">forwardable</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RaisingHash</span>
  extend <span style="color:#036;font-weight:bold">Forwardable</span>
  include <span style="color:#036;font-weight:bold">Enumerable</span>

  def_delegators(<span style="color:#A60">:@hash</span>, <span style="color:#A60">:[]</span>, <span style="color:#A60">:[]=</span>, <span style="color:#A60">:delete</span>, <span style="color:#A60">:each</span>,
                 <span style="color:#A60">:keys</span>, <span style="color:#A60">:values</span>, <span style="color:#A60">:length</span>,
                 <span style="color:#A60">:empty?</span>, <span style="color:#A60">:has_key?</span>)

  <span style="color:#777"># Forward self.earase! to @hash.delete</span>
  def_delegator(<span style="color:#A60">:@hash</span>, <span style="color:#A60">:delete</span>, <span style="color:#A60">:erase!</span>)
<span style="color:#080;font-weight:bold">end</span>
</pre>
<ul>
  <li>default_proc 方法是传给 Hash::new 的块</li>
</ul>
<h2 id="sec-4">
<span class="heading-number heading-number-1">4</span> 异常</h2>
<h3 id="sec-4-1">
<span class="heading-number heading-number-2">4.1</span> 使用定制的异常而不是抛出字符串</h3>
<h4 id="sec-4-1-1">
<span class="heading-number heading-number-3">4.1.1</span> 创建新的异常类</h4>
<ul>
  <li>必须继承 StandardError (rescue 的默认行为)</li>
  <li>异常类名称以”Error”结尾</li>
</ul>
<h4 id="sec-4-1-2">
<span class="heading-number heading-number-3">4.1.2</span> 编写异常类</h4>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CoffeeTooWeakError</span> &lt; <span style="color:#036;font-weight:bold">StandardError</span>
<span style="color:#080;font-weight:bold">end</span>

raise <span style="color:#036;font-weight:bold">CoffeeTooWeakError</span>
raise <span style="color:#036;font-weight:bold">CoffeeTooWeakError</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">coffee to water ratio too low</span><span style="color:#710">"</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TemperatureError</span> &lt; <span style="color:#036;font-weight:bold">StandardError</span>
  attr_reader <span style="color:#A60">:temperature</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(temperature)
    <span style="color:#33B">@temperature</span> = temperature
    <span style="color:#080;font-weight:bold">super</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">invalid temperature: </span><span style="color:#666">#</span><span style="color:#33B">@temperature</span><span style="color:#710">"</span></span>)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

raise TemperatureError(<span style="color:#00D">190</span>)
</pre>
<ul>
  <li>raise 既能接受异常类对象，也能接受异常类（其实是隐式调用该类 new）</li>
</ul>
<p>
</p>
<h3 id="sec-4-2">
<span class="heading-number heading-number-2">4.2</span> 通过块和 ensure 管理资源</h3>
<pre class="src" lang="ruby">
<span style="color:#036;font-weight:bold">File</span>.open(file_name, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">w</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span> | file|
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Lock</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">acquire</span>
    lock = new  <span style="color:#777"># Initialize the resource</span>
    lock.exclusive_lock!

    <span style="color:#080;font-weight:bold">if</span> block_given?
      <span style="color:#080;font-weight:bold">yield</span> lock  <span style="color:#777"># Give it to the block</span>
    <span style="color:#080;font-weight:bold">else</span>
      lock
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">ensure</span>
    <span style="color:#080;font-weight:bold">if</span> block_given?
      lock.unlock <span style="color:#080;font-weight:bold">if</span> lock
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">Lock</span>.acquire <span style="color:#080;font-weight:bold">do</span> |lock|
  <span style="color:#777"># Raising an exception here is Okay.</span>
<span style="color:#080;font-weight:bold">end</span>
<span style="color:#036;font-weight:bold">Lock</span>.acquire  <span style="color:#777"># Won't automatically unlock</span>
</pre>
<h3 id="sec-4-3">
<span class="heading-number heading-number-2">4.3</span> 通过临近的 end 退出 ensure 语句</h3>
<ul>
  <li>不要在 ensure 里 return</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">a</span>
  <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">2</span>
<span style="color:#080;font-weight:bold">ensure</span>
  <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">3</span>
<span style="color:#080;font-weight:bold">end</span>
a  <span style="color:#777">#=&gt; 3</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">a</span>
  <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">2</span>
<span style="color:#080;font-weight:bold">ensure</span>
  <span style="color:#00D">3</span>
<span style="color:#080;font-weight:bold">end</span>
a  <span style="color:#777">#=&gt; 3</span>
</pre>
<h3 id="sec-4-4">
<span class="heading-number heading-number-2">4.4</span> 限制 retry 次数，改变重试频率并记录异常信息</h3>
<pre class="src" lang="ruby">
retries = <span style="color:#00D">0</span>

<span style="color:#080;font-weight:bold">begin</span>
  service.update record
<span style="color:#080;font-weight:bold">rescue</span> <span style="color:#036;font-weight:bold">VendorDeadlockError</span> =&gt; e
  raise  <span style="color:#080;font-weight:bold">if</span> retries &gt;= <span style="color:#00D">3</span>
  retries += <span style="color:#00D">1</span>
  logger.warn(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">API failure: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>e<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">, retrying...</span><span style="color:#710">"</span></span>)
  sleep(<span style="color:#00D">5</span>**retries)
  <span style="color:#080;font-weight:bold">retry</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-4-5">
<span class="heading-number heading-number-2">4.5</span> throw 比 raise 更适合用来跳出作用域</h3>
<ul>
  <li>catch throw 是安全版的 goto</li>
  <li>可以跳出多重迭代</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">begin</span>
  <span style="color:#33B">@characters</span>.each <span style="color:#080;font-weight:bold">do</span> |character|
    <span style="color:#33B">@colors</span>.each <span style="color:#080;font-weight:bold">do</span> |colors|
      <span style="color:#080;font-weight:bold">if</span> players.valid?(character, color)
        raise <span style="color:#036;font-weight:bold">StopIteration</span>
      <span style="color:#080;font-weight:bold">end</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">rescue</span> <span style="color:#036;font-weight:bold">StopIteration</span>
  <span style="color:#777">#...</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
match = catch(<span style="color:#A60">:jump</span>) <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@characters</span>.each <span style="color:#080;font-weight:bold">do</span> |character|
    <span style="color:#33B">@colors</span>.each <span style="color:#080;font-weight:bold">do</span> |colors|
      <span style="color:#080;font-weight:bold">if</span> players.valid?(character, color)
        throw <span style="color:#A60">:jump</span>, [character, color]
      <span style="color:#080;font-weight:bold">end</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h2 id="sec-5">
<span class="heading-number heading-number-1">5</span> 元编程</h2>
<h3 id="sec-5-1">
<span class="heading-number heading-number-2">5.1</span> 熟悉 Ruby 模块和类的钩子方法</h3>
<p>六种钩子方法</p>
<h4 id="sec-5-1-1">
<span class="heading-number heading-number-3">5.1.1</span> base hooks</h4>
<table>
  <tr>
<th>hooks</th>
<th>trigger</th>
<th></th>
<th>other method</th>
<th></th>
</tr>
  <tr>
<td>included</td>
<td>include</td>
<td></td>
<td>append_features</td>
<td></td>
</tr>
  <tr>
<td>extended</td>
<td>extend</td>
<td></td>
<td>extend_object</td>
<td></td>
</tr>
  <tr>
<td>prepended</td>
<td>prepend</td>
<td></td>
<td>prepend_features</td>
<td></td>
</tr>
  <tr>
<td>inherited</td>
<td>&lt;</td>
<td></td>
<td></td>
<td></td>
</tr>
</table>
<h4 id="sec-5-1-2">
<span class="heading-number heading-number-3">5.1.2</span> other hooks</h4>
<ul>
  <li>method_added method_removed method_undefined</li>
  <li>singleton_xxx</li>
</ul>
<h4 id="sec-5-1-3">
<span class="heading-number heading-number-3">5.1.3</span> other methods</h4>
<ul>
  <li>不是钩子方法</li>
  <li>钩子调用之前的具体执行</li>
</ul>
<h3 id="sec-5-2">
<span class="heading-number heading-number-2">5.2</span> 在类的钩子方法中执行 super 方法</h3>
<ul>
  <li>在类钩子方法中适时执行 super</li>
</ul>
<h3 id="sec-5-3">
<span class="heading-number heading-number-2">5.3</span> 推荐使用 define_method 而非 method_missing</h3>
<ul>
  <li>define_method 优于使用 method_missing</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#777"># good</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AuditDecorator</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(object)
    <span style="color:#33B">@object</span> = object
    <span style="color:#33B">@logger</span> = <span style="color:#036;font-weight:bold">Logger</span>.new(<span style="color:#d70">$stdout</span>)

    <span style="color:#33B">@object</span>.public_methods.each <span style="color:#080;font-weight:bold">do</span> |name|
      define_singleton_method(name) <span style="color:#080;font-weight:bold">do</span> |*args, &amp;block|
        <span style="color:#33B">@logger</span>.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">calling '</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">' on </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span><span style="color:#33B">@object</span>.inspect<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span>)
        <span style="color:#33B">@object</span>.send(name, *args, &amp;block)
      <span style="color:#080;font-weight:bold">end</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-5-4">
<span class="heading-number heading-number-2">5.4</span> 了解不同类型的 eval 间的差异</h3>
<blockquote>
  <p>xxx_eval 方法名字透露：他们的功能，被使用的上下文</p>
</blockquote>
<h4 id="sec-5-4-1">
<span class="heading-number heading-number-3">5.4.1</span> eval</h4>
<ul>
  <li>只支持字符串参数，</li>
  <li>无法执行大段代码，且不安全</li>
  <li>如果没有指定上下文，则在当前的 eval 被使用的上下文中执行。</li>
</ul>
<h4 id="sec-5-4-2">
<span class="heading-number heading-number-3">5.4.2</span> vs</h4>
<ul>
  <li>附加比较 <code>instance_exec</code> vs <code>instance_eval</code>
</li>
  <li>
<a href="http://blog.bigbinary.com/2013/03/12/understanding-instance-exec-in-ruby.html">Understanding instance exec in ruby | BigBinary Blog</a>
    <ul>
      <li>instance_eval 有限制，不支持参数</li>
      <li>instance_exec 支持参数</li>
    </ul>
  </li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Person</span>
  code = proc { |greetings| puts greetings; puts <span style="color:#069">self</span> }

  define_method <span style="color:#A60">:name</span> <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#069">self</span>.class.instance_exec <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Good morning</span><span style="color:#710">'</span></span>, &amp;code
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Developer</span> &lt; <span style="color:#036;font-weight:bold">Person</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#036;font-weight:bold">Person</span>.new.name <span style="color:#777">#=&gt; Good morning Person</span>
<span style="color:#036;font-weight:bold">Developer</span>.new.name <span style="color:#777">#=&gt; Good morning Developer</span>
</pre>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Counter</span>
  <span style="color:#036;font-weight:bold">DEFAULT</span> = <span style="color:#00D">0</span>
  attr_reader <span style="color:#A60">:counter</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(start = <span style="color:#036;font-weight:bold">DEFAULT</span>)
    <span style="color:#33B">@counter</span> = start
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">inc</span>
    <span style="color:#33B">@counter</span> += <span style="color:#00D">1</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">Reset</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">reset_var</span>(object, name)
    object.instance_exec(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">@</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span>.to_sym) <span style="color:#080;font-weight:bold">do</span> |var|
      const = <span style="color:#069">self</span>.class.const_get(<span style="color:#A60">:DEFAULT</span>)
      instance_variable_set var, const
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

c = <span style="color:#036;font-weight:bold">Counter</span>.new(<span style="color:#00D">10</span>)
<span style="color:#036;font-weight:bold">Reset</span>.reset_var(c, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">counter</span><span style="color:#710">"</span></span>)  <span style="color:#777">#=&gt; #&lt;Counter:0x007fb63a9a4d20 @counter=10&gt;</span>
<span style="color:#036;font-weight:bold">Reset</span>.reset_var(c, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">x;</span><span style="color:#710">"</span></span>) <span style="color:#777">#=&gt; NameError: `@x;' is not allowed as an instance variable name</span>
</pre>
<h3 id="sec-5-5">
<span class="heading-number heading-number-2">5.5</span> 慎用猴子补丁</h3>
<h4 id="sec-5-5-1">
<span class="heading-number heading-number-3">5.5.1</span> 使用 refinement ( refine &amp; using)</h4>
<ul>
  <li>monkey patch 全局可见</li>
  <li>refinement 当前语法作用域才可见</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">OnlySpace</span>
  refine(<span style="color:#036;font-weight:bold">String</span>) <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">only_space?</span>
      <span style="color:#069">true</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Person</span>
  using(<span style="color:#036;font-weight:bold">OnlySpace</span>)

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(name)
    <span style="color:#33B">@name</span> = name
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">valid?</span>
    !<span style="color:#33B">@name</span>.only_space?
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">display</span>(io = <span style="color:#d70">$stdout</span>)
    io.puts(<span style="color:#33B">@name</span>)
    <span style="color:#777"># puts 中无法调用 only_space?方法</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-5-6">
<span class="heading-number heading-number-2">5.6</span> 使用别名链执行被修改的方法</h3>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">LogMethod</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">unlog_method</span>(method)
    orig = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>method<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">_without_logging</span><span style="color:#710">"</span></span>.to_sym

    <span style="color:#777"># Make sure log_method was called first</span>
    <span style="color:#080;font-weight:bold">if</span> !instance_methods.include?(orig)
      raise(<span style="color:#036;font-weight:bold">NameError</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">wass </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>orig<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> already removed?</span><span style="color:#710">"</span></span>)
    <span style="color:#080;font-weight:bold">end</span>

    <span style="color:#777"># Remove the logging version</span>
    remove_method(method)

    <span style="color:#777"># Put the method back to its original name.</span>
    alias_method method, orig

    <span style="color:#777"># Remove the name created by log_method</span>
    remove_method orig
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</pre>
<h3 id="sec-5-7">
<span class="heading-number heading-number-2">5.7</span> 支持多种 Proc 参数数量</h3>
<ul>
  <li>类型强弱，参数不匹配时处理，使用 <code>lambda?</code> 区分</li>
  <li>弱类型参数，不够 nil 凑，多余就舍弃</li>
</ul>
<table>
  <tr>
<th></th>
<th>类型</th>
<th>附录</th>
</tr>
  <tr>
<td>Proc</td>
<td>弱</td>
<td></td>
</tr>
  <tr>
<td>Lambda</td>
<td>强</td>
<td></td>
</tr>
</table>
<h4 id="sec-5-7-1">
<span class="heading-number heading-number-3">5.7.1</span> arity &amp; ~</h4>
<pre class="src" lang="ruby">
func = -&gt; (x, y = <span style="color:#00D">1</span>) { x + y }
func.arity  <span style="color:#777">#=&gt; -2 一个参数必须，一个可选</span>
func.arity  <span style="color:#777">#=&gt; 1 几个参数必须</span>

</pre>
<h3 id="sec-5-8">
<span class="heading-number heading-number-2">5.8</span> 使用模块前置时请谨慎思考</h3>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">A</span>; <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">B</span>; <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">C</span>
  include <span style="color:#036;font-weight:bold">A</span>
  include <span style="color:#036;font-weight:bold">B</span>
<span style="color:#080;font-weight:bold">end</span>
<span style="color:#777"># include 从上到下</span>
<span style="color:#036;font-weight:bold">C</span>.ancestors  <span style="color:#777">#=&gt; [C, B, A, Object, Kernel, BasicObject]</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">D</span>
  prepend <span style="color:#036;font-weight:bold">A</span>
  prepend <span style="color:#036;font-weight:bold">B</span>
<span style="color:#080;font-weight:bold">end</span>
<span style="color:#777"># prepend 从下到上</span>
<span style="color:#036;font-weight:bold">D</span>.ancestors  <span style="color:#777">#[B, A, D, Object, Kernel, BasicObject]</span>
</pre>
<h2 id="sec-6">
<span class="heading-number heading-number-1">6</span> 测试</h2>
<h3 id="sec-6-1">
<span class="heading-number heading-number-2">6.1</span> 熟悉单元测试工具 MiniTest</h3>
<h4 id="sec-6-1-1">
<span class="heading-number heading-number-3">6.1.1</span> 写测试的规范</h4>
<ul>
  <li>比如 Version 类定义在 version.rb 文件中则测试文件命名为 test_version.rb</li>
  <li>Ruby on Rails 推荐使用 <b>_test</b> 后缀</li>
  <li>类为 Versiontest &lt; MiniTest::Unit::TestCase</li>
  <li>测试用例为 <b>test_</b> 作为前缀</li>
  <li>抽取共通的逻辑放进帮助方法中(setup/teardown)</li>
</ul>
<h4 id="sec-6-1-2">
<span class="heading-number heading-number-3">6.1.2</span> 示例</h4>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">minitest/autorun</span><span style="color:#710">'</span></span>
<span style="color:#777"># 加载三个组件</span>
<span style="color:#777"># - 单元测试 unit</span>
<span style="color:#777"># - 实例化测试 spec</span>
<span style="color:#777"># - Mock</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">VersionTest</span> &lt; <span style="color:#036;font-weight:bold">MiniTest</span>::<span style="color:#036;font-weight:bold">Unit</span>::<span style="color:#036;font-weight:bold">TestCase</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">test_major_number</span>
    v = <span style="color:#036;font-weight:bold">Version</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">2.1.3</span><span style="color:#710">'</span></span>)
    assert(v.major == <span style="color:#00D">2</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">major shoud be 2</span><span style="color:#710">"</span></span>)
    <span style="color:#777"># assert_equal(2, v.major, "major")</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</pre>
<h4 id="sec-6-1-3">
<span class="heading-number heading-number-3">6.1.3</span> 断言</h4>
<ul>
  <li>assert</li>
  <li>MiniTest::Assertions
    <ul>
      <li>assert_equal</li>
      <li>refute_equal</li>
    </ul>
  </li>
</ul>
<h4 id="sec-6-1-4">
<span class="heading-number heading-number-3">6.1.4</span> minitest in Ruby on Rails</h4>
<ul>
  <li>in Rakefile</li>
</ul>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rake/testtask</span><span style="color:#710">'</span></span>

<span style="color:#036;font-weight:bold">Rake</span>::<span style="color:#036;font-weight:bold">TestTask</span>.new <span style="color:#080;font-weight:bold">do</span> |t|
  t.test_files = <span style="color:#036;font-weight:bold">FileList</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test/*_test.rb</span><span style="color:#710">'</span></span>]
  t.warning = <span style="color:#069">true</span>
<span style="color:#080;font-weight:bold">end</span>

</pre>
<h3 id="sec-6-2">
<span class="heading-number heading-number-2">6.2</span> 熟悉 MiniTest 的需求测试</h3>
<blockquote>
  <p>需求说明测试也叫行为规范测试</p>
</blockquote>
<ul>
  <li>使用 describe 替代类
    <ul>
      <li>创建继承自 Minitest::Spec 的测试类</li>
      <li>参数（转成字符串）作为匿名类的标识</li>
    </ul>
  </li>
  <li>测试用例使用 it 替代 def</li>
  <li>断言可以用 must/wont (Minitest::Expectations)</li>
  <li>before/after 替代单元测试中的 setup/teardown</li>
</ul>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">minitest/autorun</span><span style="color:#710">'</span></span>

describe(<span style="color:#036;font-weight:bold">Version</span>) <span style="color:#080;font-weight:bold">do</span>
  describe <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">when parsing</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
    before <span style="color:#080;font-weight:bold">do</span>
      <span style="color:#33B">@version</span> = <span style="color:#036;font-weight:bold">Version</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">10.2.1</span><span style="color:#710">'</span></span>)
    <span style="color:#080;font-weight:bold">end</span>

    it <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">creates three integers</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
      <span style="color:#33B">@version</span>.major.must_equal <span style="color:#00D">10</span>
      <span style="color:#33B">@version</span>.minor.must_equal <span style="color:#00D">2</span>
      <span style="color:#33B">@version</span>.path.must_equal <span style="color:#00D">1</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  describe <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">when comparing</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
    before <span style="color:#080;font-weight:bold">do</span>
      <span style="color:#33B">@v1</span> = <span style="color:#036;font-weight:bold">Version</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">2.1.1</span><span style="color:#710">'</span></span>)
      <span style="color:#33B">@v2</span> = <span style="color:#036;font-weight:bold">Version</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">2.3.0</span><span style="color:#710">'</span></span>)
    <span style="color:#080;font-weight:bold">end</span>

    it <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">orders orrectly</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
      <span style="color:#33B">@v1</span>.wont_equal <span style="color:#33B">@v2</span>
      <span style="color:#33B">@v1</span>.must_be(<span style="color:#A60">:&lt;</span>, <span style="color:#33B">@v2</span>)
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

</pre>
<h3 id="sec-6-3">
<span class="heading-number heading-number-2">6.3</span> 使用 Mock 模拟特定对象</h3>
<ul>
  <li>把测试与外界不确定性的因素分离开了</li>
  <li>verify 会验证所有期望方法被调用过</li>
  <li>更强的 Mock 可以选用 Mocha（测试完成后所有 Mock 引入的改变都被撤销）</li>
  <li>常用于项目之外的代码（gem 以及核心库等）</li>
</ul>
<pre class="src" lang="ruby">
<span style="color:#777"># coding: utf-8</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">uri</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Monitor</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(server)
    <span style="color:#33B">@server</span> = server
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">alive?</span>
    echo = <span style="color:#036;font-weight:bold">Time</span>.now.to_f.to_s
    response = get(echo)
    response.success? &amp;&amp; response == echo
  <span style="color:#080;font-weight:bold">end</span>

  private

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">get</span>(echo)
    url = <span style="color:#036;font-weight:bold">URI</span>::<span style="color:#036;font-weight:bold">HTTP</span>.build(<span style="color:#606">host</span>: <span style="color:#33B">@server</span>, <span style="color:#606">path</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/echo/</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>echo<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span>)
    <span style="color:#036;font-weight:bold">HTTP</span>.get(url.to_s)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">test_successful_monitor</span>
  monitor = <span style="color:#036;font-weight:bold">Monitor</span>.new(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">example.com</span><span style="color:#710">'</span></span>)
  response = <span style="color:#036;font-weight:bold">Minitest</span>::<span style="color:#036;font-weight:bold">Mock</span>.new

  monitor.define_singleton_method(<span style="color:#A60">:get</span>) <span style="color:#080;font-weight:bold">do</span> |echo|
    response.expect(<span style="color:#A60">:success?</span>, <span style="color:#069">true</span>)
    <span style="color:#777"># 期望的方法名，该方法的返回值</span>
    response.expect(<span style="color:#A60">:body</span>, echo)
    response
  <span style="color:#080;font-weight:bold">end</span>

  assert(monitor.alive?, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">should be alive</span><span style="color:#710">"</span></span>)
  response.verify
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h3 id="sec-6-4">
<span class="heading-number heading-number-2">6.4</span> 力争代码被有效测试过</h3>
<h4 id="sec-6-4-1">
<span class="heading-number heading-number-3">6.4.1</span> 模糊测试 - FuzzBert</h4>
<ul>
  <li>FuzzBert 会创建一个进程运行模糊测试，一直运行以便检测测试时是否崩溃</li>
  <li>随机值发生器</li>
</ul>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">fuzzbert</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">uri</span><span style="color:#710">'</span></span>

fuzz(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">URI::HTTP::build</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span>
  data(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">random server names</span><span style="color:#710">"</span></span>) <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#036;font-weight:bold">FuzzBert</span>::<span style="color:#036;font-weight:bold">Generators</span>.random
  <span style="color:#080;font-weight:bold">end</span>

  deploy <span style="color:#080;font-weight:bold">do</span> |data|
    <span style="color:#036;font-weight:bold">URI</span>::<span style="color:#036;font-weight:bold">HTTP</span>.build(<span style="color:#606">hosts</span>: data, <span style="color:#606">path</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h4 id="sec-6-4-2">
<span class="heading-number heading-number-3">6.4.2</span> 属性测试 - MrProper</h4>
<ul>
  <li>给 data 传入一个包含三个整数类的数组</li>
</ul>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">mrproper</span><span style="color:#710">'</span></span>

properties(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Version</span><span style="color:#710">"</span></span>) <span style="color:#080;font-weight:bold">do</span>
  data([<span style="color:#036;font-weight:bold">Integer</span>, <span style="color:#036;font-weight:bold">Integer</span>, <span style="color:#036;font-weight:bold">Integer</span>])

  property(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">new(str).to_s == str</span><span style="color:#710">"</span></span>) <span style="color:#080;font-weight:bold">do</span> |data|
    str = data.join(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">.</span><span style="color:#710">'</span></span>)
    assert_equal(str, <span style="color:#036;font-weight:bold">Version</span>.new(str).to_s)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h4 id="sec-6-4-3">
<span class="heading-number heading-number-3">6.4.3</span> 覆盖率测试 - SimpleCov</h4>
<blockquote>
  <p>建议把自动化测试集成到持续集成工具之中</p>
</blockquote>
<h2 id="sec-7">
<span class="heading-number heading-number-1">7</span> 工具与库</h2>
<h3 id="sec-7-1">
<span class="heading-number heading-number-2">7.1</span> 学会使用 Ruby 文档</h3>
<h4 id="sec-7-1-1">
<span class="heading-number heading-number-3">7.1.1</span> ri</h4>
<pre class="example">
ri Array
File::open
Time#hour
clear
bundler:
bundler:README.md
</pre>
<ul>
  <li>ri –help</li>
</ul>
<h4 id="sec-7-1-2">
<span class="heading-number heading-number-3">7.1.2</span> RDoc</h4>
<ul>
  <li>RDoc::Markup</li>
</ul>
<pre class="example">
rdoc -f ri
rdoc -f darkfish  # generate HTML doc

</pre>
<h3 id="sec-7-2">
<span class="heading-number heading-number-2">7.2</span> 认识 IRB 的高级特性</h3>
<h4 id="sec-7-2-1">
<span class="heading-number heading-number-3">7.2.1</span> 环境配置</h4>
<ul>
  <li>~/.irbrc</li>
  <li>$IRBRC</li>
</ul>
<pre class="example">
IRB.conf[:AUTO_INDENT] = true
</pre>
<pre class="src" lang="ruby">
<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">IRB::ExtendCommandBundle</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">time</span>(&amp;block)
    <span style="color:#777">#...</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
<h4 id="sec-7-2-2">
<span class="heading-number heading-number-3">7.2.2</span> irb 命令</h4>
<ul>
  <li>特殊变量</li>
</ul>
<blockquote>
  <p><b>_</b> irb 中执行过的上一个表达式结果
    irb 会新建个新会话</p>
</blockquote>
<ul>
  <li>jobs/fg</li>
</ul>
<h4 id="sec-7-2-3">
<span class="heading-number heading-number-3">7.2.3</span> 可选用更强大的 <b>Pry</b>
</h4>
<h3 id="sec-7-3">
<span class="heading-number heading-number-2">7.3</span> 用 Bundler 管理 Gem 依赖</h3>
<ul>
  <li>generate gemfile</li>
</ul>
<pre class="example">
gem install bundler

bundle init

# Gemfile
source 'https://rubygems.org'

</pre>
<ul>
  <li>init rubygem</li>
</ul>
<pre class="example">
# init rubygem
bundle install 

# File
require 'bundle/setup'  # Gemfile 中的包
Bundle.require  # 其他依赖的 gem

bundle gem mp3json

# Gemfile
source 'http://rubygems.org'

gemspec

#======

# mp3json.gemspec
Gem::Specification.new do |gem|
  gem.add_dependency('json', '1.9.1')
end
</pre>
<blockquote>
  <p>打包 RubyGem 时不要吧 <b>Gemfile.lock</b> 放入版本控制</p>
</blockquote>
<h3 id="sec-7-4">
<span class="heading-number heading-number-2">7.4</span> 为 Gem 依赖设定版本上限</h3>
<blockquote>
  <p>保证一次只更新一个 gem
    bundle update xxx</p>
</blockquote>
<pre class="example">
# good
gem 'money', '~&gt; 5.1.0'
# == gem 'money', '&gt;= 5.1.0', '&lt; 5.2.0'

gem.add_dependency 'money', '&gt;= 4.2.0', '&lt; 5.2.0'
</pre>
<blockquote>
  <p>应用原来需要的 B_Gem 版本，和引入一个 A_Gem 所依赖而 B_Gem 不能冲突。
    即程序需要两个不同版本的 Gem 是不允许的。（在安全范围内，版本上限越宽越好，可以扩展到下一个主要发布版本之前）</p>
</blockquote>
<h2 id="sec-8">
<span class="heading-number heading-number-1">8</span> 内存管理与性能</h2>
<h3 id="sec-8-1">
<span class="heading-number heading-number-2">8.1</span> 熟悉 Ruby 的垃圾收集器</h3>
<ul>
  <li>原理：标记-清除</li>
  <li>Ruby2.1 对象分为两类
    <ul>
      <li>年轻代</li>
      <li>年老代 - 比如：常量</li>
    </ul>
  </li>
  <li>标记阶段：
    <ul>
      <li>主要标记 - 针对所有对象，开销大</li>
      <li>次要标记 - 仅针对年轻代</li>
    </ul>
  </li>
  <li>Ruby 内存池 - 堆 - heap
    <ul>
      <li>内存页 - page
        <ul>
          <li>槽 - slot</li>
          <li>
        </li>
</ul>
      </li>
    </ul>
  </li>
</ul>
<blockquote>
  <p>当程序启动时，Ruby 会分配若干页放到堆中，
    创建新对象时，垃圾收集器会首先寻找空槽来存储该对象，
    如果没有空槽，会触发懒惰清除过程（释放一个空槽），
    如果还不能，则分配一个新的页到堆中。</p>
  <p>清除过程中，如果一个页中所有的槽全为空，则整页释放。</p>
</blockquote>
<ul>
  <li>Ruby2.1 默认页大小 10K, 一页 408 个槽(40B)</li>
  <li>GC.stat</li>
</ul>
<h3 id="sec-8-2">
<span class="heading-number heading-number-2">8.2</span> 用 Finalizer 构建资源安全网</h3>
<pre class="src" lang="ruby">
<span style="color:#036;font-weight:bold">ObjectSpace</span>.define_finalizer(<span style="color:#069">self</span>, finalizer)
</pre>
<ul>
  <li>创建闭包会导致资源不会释放
    <ul>
      <li>闭包还会获取 self 变量</li>
      <li>所以，不能指向资源对象</li>
    </ul>
  </li>
</ul>
<h3 id="sec-8-3">
<span class="heading-number heading-number-2">8.3</span> 认识 Ruby 性能分析工具</h3>
<h4 id="sec-8-3-1">
<span class="heading-number heading-number-3">8.3.1</span> 选型</h4>
<ul>
  <li>stackprof / memory_profiler &gt; ruby-prof &gt; profile</li>
</ul>
<pre class="src" lang="sh">
ruby -rprofile script.rb

ruby-prof --mode=memory script.rb
</pre>
<pre class="src" lang="ruby">
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">stackprof</span><span style="color:#710">'</span></span>

<span style="color:#036;font-weight:bold">StackProfile</span>.run <span style="color:#606">out</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">profile.dump</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777">#...</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># stackprof profile.dump</span>
</pre>
<h3 id="sec-8-4">
<span class="heading-number heading-number-2">8.4</span> 避免在循环中使用对象字面量</h3>
<pre class="src" lang="ruby">
<span style="color:#777"># bad bad bad</span>
errors.any? { |e| <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%w(</span><span style="color:#D20">F1 F2 F3</span><span style="color:#710">)</span></span>.include?(e.code) }

<span style="color:#777"># good</span>
<span style="color:#036;font-weight:bold">FATAL_CODES</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%w(</span><span style="color:#D20">F1 F2 F3</span><span style="color:#710">)</span></span>.map(&amp;<span style="color:#A60">:freeze</span>).freeze
errors.any? { |e| <span style="color:#036;font-weight:bold">FATAL_CODES</span>.include?(e.code) }

<span style="color:#777"># &gt; 2.1 good</span>
errors.any? { |e| e.code == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">FATAL</span><span style="color:#710">'</span></span>.freeze }

</pre>
<h3 id="sec-8-5">
<span class="heading-number heading-number-2">8.5</span> 考虑记忆化大开销计算</h3>
<pre class="src" lang="ruby">
<span style="color:#777"># bad</span>
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">shipped?</span>(order_id)
  file = fetch_confirmation_file

  <span style="color:#080;font-weight:bold">if</span> file
    status = parse_confirmation_file(file)
    status[order_id] = <span style="color:#A60">:shipped</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># good</span>
<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">shipped?</span>(order_id)
  <span style="color:#33B">@status</span> ||= <span style="color:#080;font-weight:bold">begin</span>
                file = fetch_confirmation_file
                file ? parse_confirmation_file(file) : {}
              <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#33B">@status</span>[order_id] = <span style="color:#A60">:shipped</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">lookup</span>(key)
  <span style="color:#33B">@cache</span> ||= {}
  <span style="color:#33B">@cache</span>[key] ||= <span style="color:#080;font-weight:bold">begin</span>
                    <span style="color:#777">#...</span>
                  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre>
</article>
          <aside class="col-md-3 sidebar-toc">
            <nav class="notes-sidebar  hidden-xs hidden-sm" id="notes-sidebar"><ul class="nav nav-stacked fixed">
<li>
<a href="#sec-1">
1 &#x8BA9;&#x81EA;&#x5DF1;&#x719F;&#x6089; Ruby</a><ul class="nav nav-stacked">
<li><a href="#sec-1-1">
1.1 &#x7406;&#x89E3; Ruby &#x4E2D;&#x7684; True</a></li>
<li><a href="#sec-1-2">
1.2 &#x6240;&#x6709;&#x5BF9;&#x8C61;&#x7684;&#x503C;&#x90FD;&#x53EF;&#x80FD;&#x4E3A; nil</a></li>
<li><a href="#sec-1-3">
1.3 &#x907F;&#x514D;&#x4F7F;&#x7528; Ruby &#x4E2D;&#x53E4;&#x602A;&#x7684; Perl &#x98CE;&#x683C;&#x8BED;&#x6CD5;</a></li>
<li><a href="#sec-1-4">
1.4 &#x7559;&#x795E;&#xFF0C;&#x5E38;&#x91CF;&#x662F;&#x53EF;&#x53D8;&#x7684;</a></li>
<li><a href="#sec-1-5">
1.5 &#x7559;&#x610F;&#x8FD0;&#x884C;&#x65F6;&#x8B66;&#x544A;</a></li>
</ul>
</li>
<li>
<a href="#sec-2">
2 &#x7C7B;&#x3001;&#x5BF9;&#x8C61;&#x548C;&#x6A21;&#x5757;</a><ul class="nav nav-stacked">
<li><a href="#sec-2-1">
2.1 &#x4E86;&#x89E3; Ruby &#x5982;&#x4F55;&#x6784;&#x5EFA;&#x7EE7;&#x627F;&#x4F53;&#x7CFB;</a></li>
<li><a href="#sec-2-2">
2.2 &#x4E86;&#x89E3; super &#x7684;&#x4E0D;&#x540C;&#x884C;&#x4E3A;</a></li>
<li><a href="#sec-2-3">
2.3 &#x521D;&#x59CB;&#x5316;&#x5B50;&#x7C7B;&#x65F6;&#x8C03;&#x7528; super</a></li>
<li><a href="#sec-2-4">
2.4 &#x63D0;&#x9632; Ruby &#x6700;&#x68D8;&#x624B;&#x7684;&#x89E3;&#x6790;</a></li>
<li><a href="#sec-2-5">
2.5 &#x63A8;&#x8350;&#x4F7F;&#x7528; Struct &#x800C;&#x975E; Hash &#x5B58;&#x50A8;&#x7ED3;&#x6784;&#x5316;&#x6570;&#x636E;</a></li>
<li><a href="#sec-2-6">
2.6 &#x901A;&#x8FC7;&#x5728;&#x6A21;&#x5757;&#x4E2D;&#x5D4C;&#x5165;&#x4EE3;&#x7801;&#x6765;&#x521B;&#x5EFA;&#x547D;&#x540D;&#x7A7A;&#x95F4;</a></li>
<li><a href="#sec-2-7">
2.7 &#x7406;&#x89E3;&#x7B49;&#x4EF7;&#x7684;&#x4E0D;&#x540C;&#x7528;&#x6CD5;</a></li>
<li><a href="#sec-2-8">
2.8 &#x901A;&#x8FC7;&#x201D;&lt;=&gt;&#x201D;&#x64CD;&#x4F5C;&#x7B26;&#x5B9E;&#x73B0;&#x6BD4;&#x8F83;&#x548C;&#x6BD4;&#x8F83;&#x6A21;&#x5757;</a></li>
<li><a href="#sec-2-9">
2.9 &#x901A;&#x8FC7; protected &#x65B9;&#x6CD5;&#x5171;&#x4EAB;&#x79C1;&#x6709;&#x72B6;&#x6001;</a></li>
<li><a href="#sec-2-10">
2.10 &#x4F18;&#x5148;&#x4F7F;&#x7528;&#x5B9E;&#x4F8B;&#x53D8;&#x91CF;&#x800C;&#x975E;&#x7C7B;&#x53D8;&#x91CF;</a></li>
</ul>
</li>
<li>
<a href="#sec-3">
3 &#x96C6;&#x5408;</a><ul class="nav nav-stacked">
<li><a href="#sec-3-1">
3.1 &#x5728;&#x6539;&#x53D8;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x7684;&#x96C6;&#x5408;&#x4E4B;&#x524D;&#x590D;&#x5236;&#x5B83;&#x4EEC;</a></li>
<li><a href="#sec-3-2">
3.2 &#x4F7F;&#x7528; Array &#x65B9;&#x6CD5;&#x5C06; nil &#x53CA;&#x6807;&#x91CF;&#x5BF9;&#x8C61;&#x8F6C;&#x6362;&#x6210;&#x6570;&#x7EC4;</a></li>
<li><a href="#sec-3-3">
3.3 &#x8003;&#x8651;&#x4F7F;&#x7528;&#x96C6;&#x5408;&#x9AD8;&#x6548;&#x68C0;&#x67E5;&#x5143;&#x7D20;&#x7684;&#x5305;&#x542B;&#x6027;</a></li>
<li><a href="#sec-3-4">
3.4 &#x4E86;&#x89E3;&#x5982;&#x4F55;&#x901A;&#x8FC7; reduce &#x65B9;&#x6CD5;&#x6298;&#x53E0;&#x96C6;&#x5408;</a></li>
<li><a href="#sec-3-5">
3.5 &#x8003;&#x8651;&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;&#x54C8;&#x5E0C;&#x503C;</a></li>
<li><a href="#sec-3-6">
3.6 &#x5BF9;&#x96C6;&#x5408;&#x4F18;&#x5148;&#x4F7F;&#x7528;&#x59D4;&#x6258;&#x800C;&#x975E;&#x7EE7;&#x627F;</a></li>
</ul>
</li>
<li>
<a href="#sec-4">
4 &#x5F02;&#x5E38;</a><ul class="nav nav-stacked">
<li><a href="#sec-4-1">
4.1 &#x4F7F;&#x7528;&#x5B9A;&#x5236;&#x7684;&#x5F02;&#x5E38;&#x800C;&#x4E0D;&#x662F;&#x629B;&#x51FA;&#x5B57;&#x7B26;&#x4E32;</a></li>
<li><a href="#sec-4-2">
4.2 &#x901A;&#x8FC7;&#x5757;&#x548C; ensure &#x7BA1;&#x7406;&#x8D44;&#x6E90;</a></li>
<li><a href="#sec-4-3">
4.3 &#x901A;&#x8FC7;&#x4E34;&#x8FD1;&#x7684; end &#x9000;&#x51FA; ensure &#x8BED;&#x53E5;</a></li>
<li><a href="#sec-4-4">
4.4 &#x9650;&#x5236; retry &#x6B21;&#x6570;&#xFF0C;&#x6539;&#x53D8;&#x91CD;&#x8BD5;&#x9891;&#x7387;&#x5E76;&#x8BB0;&#x5F55;&#x5F02;&#x5E38;&#x4FE1;&#x606F;</a></li>
<li><a href="#sec-4-5">
4.5 throw &#x6BD4; raise &#x66F4;&#x9002;&#x5408;&#x7528;&#x6765;&#x8DF3;&#x51FA;&#x4F5C;&#x7528;&#x57DF;</a></li>
</ul>
</li>
<li>
<a href="#sec-5">
5 &#x5143;&#x7F16;&#x7A0B;</a><ul class="nav nav-stacked">
<li><a href="#sec-5-1">
5.1 &#x719F;&#x6089; Ruby &#x6A21;&#x5757;&#x548C;&#x7C7B;&#x7684;&#x94A9;&#x5B50;&#x65B9;&#x6CD5;</a></li>
<li><a href="#sec-5-2">
5.2 &#x5728;&#x7C7B;&#x7684;&#x94A9;&#x5B50;&#x65B9;&#x6CD5;&#x4E2D;&#x6267;&#x884C; super &#x65B9;&#x6CD5;</a></li>
<li><a href="#sec-5-3">
5.3 &#x63A8;&#x8350;&#x4F7F;&#x7528; define_method &#x800C;&#x975E; method_missing</a></li>
<li><a href="#sec-5-4">
5.4 &#x4E86;&#x89E3;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684; eval &#x95F4;&#x7684;&#x5DEE;&#x5F02;</a></li>
<li><a href="#sec-5-5">
5.5 &#x614E;&#x7528;&#x7334;&#x5B50;&#x8865;&#x4E01;</a></li>
<li><a href="#sec-5-6">
5.6 &#x4F7F;&#x7528;&#x522B;&#x540D;&#x94FE;&#x6267;&#x884C;&#x88AB;&#x4FEE;&#x6539;&#x7684;&#x65B9;&#x6CD5;</a></li>
<li><a href="#sec-5-7">
5.7 &#x652F;&#x6301;&#x591A;&#x79CD; Proc &#x53C2;&#x6570;&#x6570;&#x91CF;</a></li>
<li><a href="#sec-5-8">
5.8 &#x4F7F;&#x7528;&#x6A21;&#x5757;&#x524D;&#x7F6E;&#x65F6;&#x8BF7;&#x8C28;&#x614E;&#x601D;&#x8003;</a></li>
</ul>
</li>
<li>
<a href="#sec-6">
6 &#x6D4B;&#x8BD5;</a><ul class="nav nav-stacked">
<li><a href="#sec-6-1">
6.1 &#x719F;&#x6089;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x5DE5;&#x5177; MiniTest</a></li>
<li><a href="#sec-6-2">
6.2 &#x719F;&#x6089; MiniTest &#x7684;&#x9700;&#x6C42;&#x6D4B;&#x8BD5;</a></li>
<li><a href="#sec-6-3">
6.3 &#x4F7F;&#x7528; Mock &#x6A21;&#x62DF;&#x7279;&#x5B9A;&#x5BF9;&#x8C61;</a></li>
<li><a href="#sec-6-4">
6.4 &#x529B;&#x4E89;&#x4EE3;&#x7801;&#x88AB;&#x6709;&#x6548;&#x6D4B;&#x8BD5;&#x8FC7;</a></li>
</ul>
</li>
<li>
<a href="#sec-7">
7 &#x5DE5;&#x5177;&#x4E0E;&#x5E93;</a><ul class="nav nav-stacked">
<li><a href="#sec-7-1">
7.1 &#x5B66;&#x4F1A;&#x4F7F;&#x7528; Ruby &#x6587;&#x6863;</a></li>
<li><a href="#sec-7-2">
7.2 &#x8BA4;&#x8BC6; IRB &#x7684;&#x9AD8;&#x7EA7;&#x7279;&#x6027;</a></li>
<li><a href="#sec-7-3">
7.3 &#x7528; Bundler &#x7BA1;&#x7406; Gem &#x4F9D;&#x8D56;</a></li>
<li><a href="#sec-7-4">
7.4 &#x4E3A; Gem &#x4F9D;&#x8D56;&#x8BBE;&#x5B9A;&#x7248;&#x672C;&#x4E0A;&#x9650;</a></li>
</ul>
</li>
<li>
<a href="#sec-8">
8 &#x5185;&#x5B58;&#x7BA1;&#x7406;&#x4E0E;&#x6027;&#x80FD;</a><ul class="nav nav-stacked">
<li><a href="#sec-8-1">
8.1 &#x719F;&#x6089; Ruby &#x7684;&#x5783;&#x573E;&#x6536;&#x96C6;&#x5668;</a></li>
<li><a href="#sec-8-2">
8.2 &#x7528; Finalizer &#x6784;&#x5EFA;&#x8D44;&#x6E90;&#x5B89;&#x5168;&#x7F51;</a></li>
<li><a href="#sec-8-3">
8.3 &#x8BA4;&#x8BC6; Ruby &#x6027;&#x80FD;&#x5206;&#x6790;&#x5DE5;&#x5177;</a></li>
<li><a href="#sec-8-4">
8.4 &#x907F;&#x514D;&#x5728;&#x5FAA;&#x73AF;&#x4E2D;&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x5B57;&#x9762;&#x91CF;</a></li>
<li><a href="#sec-8-5">
8.5 &#x8003;&#x8651;&#x8BB0;&#x5FC6;&#x5316;&#x5927;&#x5F00;&#x9500;&#x8BA1;&#x7B97;</a></li>
</ul>
</li>
</ul></nav>
          </aside>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">Contributes &amp; License</div>
    </footer>
    <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf-8">
     $('#notes-sidebar').affix({
       offset: {
         top: $('#notes-sidebar').offset().top,
         bottom: ($('footer').outerHeight(true))
       }
     });
    </script>
  </body>
</html>
